<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vedic Astrology Chart</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 2rem; }
    .grid { display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; }
    label { display: block; margin-top: 0.5rem; font-weight: 600; }
    input, select { width: 100%; padding: 0.5rem; }
    button { padding: 0.6rem 1rem; margin-top: 1rem; }
    pre { background: #f7f7f9; padding: 1rem; overflow: auto; max-height: 300px; }
    canvas { width: 100%; height: 520px; border: 1px solid #ddd; margin-bottom: 1rem; }
    .row { display:flex; gap:1rem; align-items:end }
    
    /* Collapsible Sections */
    .section-container {
      border: 1px solid #ddd;
      border-radius: 8px;
      margin: 1rem 0;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .section-header {
      padding: 1rem;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 8px 8px 0 0;
      transition: background 0.2s ease;
    }
    
    .section-header:hover {
      background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    }
    
    .section-title {
      font-weight: 600;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .section-summary {
      color: #6c757d;
      font-size: 0.9rem;
      margin-left: 1.5rem;
    }
    
    .section-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    
    .download-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    
    .download-btn:hover {
      background: #218838;
    }
    
    .expand-icon {
      font-size: 1.2rem;
      transition: transform 0.2s ease;
      color: #6c757d;
    }
    
    .section-expanded .expand-icon {
      transform: rotate(180deg);
    }
    
    .section-content {
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    
    .section-expanded .section-content {
      max-height: 2000px;
      padding: 1rem;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.5rem 0;
    }
    
    .data-table th,
    .data-table td {
      padding: 0.5rem;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }
    
    .data-table th {
      background: #f8f9fa;
      font-weight: 600;
    }
    
    .data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin: 0.5rem 0;
    }
    
    .data-card {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
      border-left: 4px solid #007bff;
    }
    
    .highlight {
      background: #fff3cd;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      border-left: 3px solid #ffc107;
    }
  </style>
</head>
<body>
  <h1>Vedic Astrology Chart</h1>
  <div class="grid">
    <div>
      <label>Place</label>
      <div class="row" style="align-items:center; gap:0.5rem; position:relative">
        <input id="place" type="text" placeholder="City, State, Country" autocomplete="off" autocapitalize="off" spellcheck="false" oninput="onPlaceInput()" onkeydown="onPlaceKey(event)" style="flex:1" />
        <button type="button" onclick="applyPlace()">Find</button>
        <div id="place-list" style="position:absolute; top:100%; left:0; right:0; z-index:9999"></div>
      </div>
      <label>Date & Time (local)</label>
      <input id="dt" type="datetime-local" />
      <label>Latitude</label>
      <input id="lat" type="number" step="0.0001" placeholder="e.g. 28.6139" />
      <label>Longitude</label>
      <input id="lon" type="number" step="0.0001" placeholder="e.g. 77.2090" />
      <div class="row">
        <div style="flex:1">
          <label>Timezone offset (hours)</label>
          <input id="tz" type="number" step="0.25" placeholder="e.g. 5.5" />
        </div>
        <div></div>
      </div>
      <label>Ayanamsa</label>
      <select id="ayan">
        <option value="lahiri" selected>Lahiri (default)</option>
        <option value="krishnamurti">Krishnamurti</option>
      </select>
      <label>House system</label>
      <select id="house">
        <option value="equal" selected>Equal (default)</option>
        <option value="whole">Whole Sign</option>
        <option value="placidus">Placidus</option>
        <option value="koch">Koch</option>
        <option value="porphyry">Porphyry</option>
      </select>
      <label>Node type</label>
      <select id="nodeType">
        <option value="mean" selected>Mean (default)</option>
        <option value="true">True</option>
      </select>
      <button onclick="submitForm()">Generate</button>
      <div id="err" style="color:crimson; margin-top:0.5rem"></div>
    </div>
    <div id="results-container">
      <canvas id="chart"></canvas>
      
      <!-- Collapsible Sections -->
      <div id="sections-container" style="display: none;">
        
        <!-- Birth Chart Overview Section -->
        <div class="section-container" id="section-chart">
          <div class="section-header" onclick="toggleSection('chart')">
            <div>
              <div class="section-title">
                <span>üéØ</span>Birth Chart Overview
              </div>
              <div class="section-summary" id="chart-summary">Chart details and basic information</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('birth_info')" title="Download birth info as JSON">üì• JSON</button>
              <span class="expand-icon" id="chart-icon">‚ñº</span>
            </div>
          </div>
          <div class="section-content" id="chart-content">
            <div id="chart-details"></div>
          </div>
        </div>
        
        <!-- Planetary Positions Section -->
        <div class="section-container" id="section-planets">
          <div class="section-header" onclick="toggleSection('planets')">
            <div>
              <div class="section-title">
                <span>ü™ê</span>Planetary Positions
              </div>
              <div class="section-summary" id="planets-summary">Detailed planetary analysis</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('planets')" title="Download planetary data as JSON">üì• JSON</button>
              <span class="expand-icon" id="planets-icon">‚ñº</span>
            </div>
          </div>
          <div class="section-content" id="planets-content">
            <div id="planets-details"></div>
          </div>
        </div>
        
        <!-- House Analysis Section -->
        <div class="section-container" id="section-houses">
          <div class="section-header" onclick="toggleSection('houses')">
            <div>
              <div class="section-title">
                <span>üè†</span>House Analysis
              </div>
              <div class="section-summary" id="houses-summary">House cusps and significances</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('houses')" title="Download house data as JSON">üì• JSON</button>
              <span class="expand-icon" id="houses-icon">‚ñº</span>
            </div>
          </div>
          <div class="section-content" id="houses-content">
            <div id="houses-details"></div>
          </div>
        </div>
        
        <!-- Nakshatra Analysis Section -->
        <div class="section-container" id="section-nakshatras">
          <div class="section-header" onclick="toggleSection('nakshatras')">
            <div>
              <div class="section-title">
                <span>üåü</span>Nakshatra Analysis
              </div>
              <div class="section-summary" id="nakshatras-summary">Detailed nakshatra positions</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('nakshatras')" title="Download nakshatra data as JSON">üì• JSON</button>
              <span class="expand-icon" id="nakshatras-icon">‚ñº</span>
            </div>
          </div>
          <div class="section-content" id="nakshatras-content">
            <div id="nakshatras-details"></div>
          </div>
        </div>
        
        <!-- Current Transits Section -->
        <div class="section-container" id="section-transits">
          <div class="section-header" onclick="toggleSection('transits')">
            <div>
              <div class="section-title">
                <span>üîÑ</span>Current Transits
              </div>
              <div class="section-summary" id="transits-summary">Current planetary positions vs birth chart</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('transits')" title="Download transit data as JSON">üì• JSON</button>
              <span class="expand-icon" id="transits-icon">‚ñº</span>
            </div>
          </div>
          <div class="section-content" id="transits-content">
            <div id="transits-details"></div>
          </div>
        </div>
        
        <!-- Vimshottari Dasha Section -->
        <div class="section-container" id="section-mahadasha">
          <div class="section-header" onclick="toggleSection('mahadasha')">
            <div>
              <div class="section-title">
                <span>‚è∞</span>Vimshottari Dasha
              </div>
              <div class="section-summary" id="mahadasha-summary">120-year dasha timeline</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('mahadasha')" title="Download dasha data as JSON">üì• JSON</button>
              <span class="expand-icon" id="mahadasha-icon">‚ñº</span>
            </div>
          </div>
          <div class="section-content" id="mahadasha-content">
            <div id="mahadasha-details"></div>
          </div>
        </div>
        
        <!-- Yearly Dasha Calendar Section -->
        <div class="section-container" id="section-yearly">
          <div class="section-header" onclick="toggleSection('yearly')">
            <div>
              <div class="section-title">
                <span>üìÖ</span>Yearly Dasha Calendar
              </div>
              <div class="section-summary" id="yearly-summary">Year-by-year dasha breakdown</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('yearly_dasha')" title="Download yearly calendar as JSON">üì• JSON</button>
              <span class="expand-icon" id="yearly-icon">‚ñº</span>
            </div>
          </div>
          <div class="section-content" id="yearly-content">
            <div id="yearly-details"></div>
          </div>
        </div>
        
        <!-- Complete Data Download -->
        <div class="section-container" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
          <div class="section-header" style="background: transparent; cursor: default;">
            <div>
              <div class="section-title">
                <span>üíæ</span>Complete Chart Data
              </div>
              <div class="section-summary">Download all data in one AI-readable JSON file</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('complete')" style="background: #1976d2;" title="Download complete chart as JSON">üì• Complete JSON</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Legacy output (hidden by default) -->
      <details style="margin-top: 1rem;">
        <summary style="cursor: pointer; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">üîç Raw Data (for debugging)</summary>
        <pre id="out" style="margin-top: 0.5rem;"></pre>
      </details>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('chart');
    const ctx = canvas.getContext('2d');
    // Prefill local datetime and timezone offset (in hours)
    (function prefillDefaults(){
      try {
        const now = new Date();
        const pad = n => String(n).padStart(2,'0');
        const local = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
        document.getElementById('dt').value = local;
        const tzHours = -now.getTimezoneOffset()/60; // e.g., IST => 5.5
        document.getElementById('tz').value = tzHours;
      } catch {}
    })();

    // Draw a South Indian style chart: a square subdivided into 12 fixed boxes.
    function drawChart(data) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const w = canvas.width, h = canvas.height;
      const pad = 20;
      const boxW = (w - pad*2) / 4;
      const boxH = (h - pad*2) / 4;

      ctx.strokeStyle = '#333';
      ctx.lineWidth = 2;
      // Outer border
      ctx.strokeRect(pad, pad, w-2*pad, h-2*pad);

      // South Indian fixed grid coordinates for 12 houses (row, col) 4x4, skipping center as split boxes
      const houseGrid = [
        [1,1], [0,1], [0,2], [1,2], [2,2], [2,1], [2,0], [1,0], [0,0], [0,3], [3,3], [3,0]
      ];

      // draw all small boxes
      ctx.font = '12px sans-serif';
      ctx.fillStyle = '#111';
      for (let i=0;i<12;i++){
        const [r,c] = houseGrid[i];
        const x = pad + c*boxW;
        const y = pad + r*boxH;
        ctx.strokeRect(x, y, boxW, boxH);
        const deg = data.houses[String(i+1)];
        ctx.fillText(`${i+1}`, x+4, y+14);
        if (deg !== undefined) {
          ctx.fillText(`${deg.toFixed(1)}¬∞`, x+4, y+28);
        }
      }

      // Place planet labels inside their house box with simple stacking, using planetsByHouse
      const houseStacks = Array.from({length:12},()=>[]);
      for (let i=1; i<=12; i++){
        const arr = (data.planetsByHouse && data.planetsByHouse[String(i)]) || [];
        for (const p of arr){
          const label = `${p.abbr || p.name} ${p.sign} ${p.degInSign.toFixed ? p.degInSign.toFixed(1) : p.degInSign}¬∞`;
          houseStacks[i-1].push(label);
        }
      }

      for (let i=0;i<12;i++){
        const [r,c] = houseGrid[i];
        const x = pad + c*boxW + 4;
        const y = pad + r*boxH + 42;
        let yy=y;
        for (const label of houseStacks[i]){
          ctx.fillText(label, x, yy);
          yy += 14;
        }
      }

      // Legend
      ctx.fillText(`Asc: ${data.ascendant.toFixed(1)}¬∞`, pad, h - pad + 14);
    }

    async function submitForm() {
      const err = document.getElementById('err');
      err.textContent = '';
      const dt = document.getElementById('dt').value;
      const place = document.getElementById('place').value;
      const lat = document.getElementById('lat').value;
      const lon = document.getElementById('lon').value;
      const tz = document.getElementById('tz').value;
      const ayan = document.getElementById('ayan').value;
      const house = document.getElementById('house').value;
      const nodeType = document.getElementById('nodeType').value;
      
      // Enhanced validation
      if (!dt) { err.textContent = 'Please set date/time.'; return; }
      
      // Check if we have either a place OR lat/lon coordinates
      if (!place && (!lat || !lon)) {
        err.textContent = 'Please enter a place name OR provide latitude and longitude coordinates.'; 
        return; 
      }
      
      // If lat/lon provided, validate they are numbers
      if (lat && isNaN(parseFloat(lat))) {
        err.textContent = 'Latitude must be a valid number.'; 
        return; 
      }
      
      if (lon && isNaN(parseFloat(lon))) {
        err.textContent = 'Longitude must be a valid number.'; 
        return; 
      }
      
      // Debug logging
      console.log('DEBUG: Submitting with values:');
      console.log('dt:', dt);
      console.log('place:', place);
      console.log('lat:', lat);
      console.log('lon:', lon);
      console.log('tz:', tz);
      
      try {
        const res = await fetch('/api/chart', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ datetime: dt, place, lat, lon, tz_offset: tz, ayanamsa: ayan, house_system: house, node_type: nodeType })
        });
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || 'Failed');
        drawChart(json.data);
        document.getElementById('out').textContent = JSON.stringify(json.data, null, 2);
        renderAllSections(json.data);
      } catch (e) {
        console.error('DEBUG: Error in submitForm:', e);
        console.error('DEBUG: Full error:', e.message);
        err.textContent = e.message;
      }
    }

    // Simple place autosuggest with caching and fast selection
    let placeTimer;
    const placeCache = new Map(); // q(lower) -> [{name,lat,lon}]
    async function onPlaceInput(){
      const q = document.getElementById('place').value.trim();
      const list = document.getElementById('place-list');
      if (placeTimer) clearTimeout(placeTimer);
      if (q.length < 3) { list.innerHTML=''; return; }
      const key = q.toLowerCase();
      // If cached, show immediately for responsiveness
      if (placeCache.has(key)) {
        renderPlaceList(list, placeCache.get(key));
      } else {
        list.innerHTML = `<div style="background:#fff; border:1px solid #ddd; padding:8px">Searching‚Ä¶</div>`;
      }
      placeTimer = setTimeout(async () => {
        try {
          const res = await fetch(`/api/places?q=${encodeURIComponent(q)}`);
          const json = await res.json();
          if (!json.ok) throw new Error(json.error||'place search failed');
          placeCache.set(key, json.data || []);
          renderPlaceList(list, placeCache.get(key));
        } catch(e) { list.innerHTML=''; }
      }, 120);
    }

    function renderPlaceList(list, data){
      const items = (data||[]).map(i => `<div class="item" data-lat="${i.lat}" data-lon="${i.lon}" style="padding:6px 8px; cursor:pointer; border-bottom:1px solid #eee">${i.name}</div>`).join('');
      list.innerHTML = items ? `<div id="place-dd" style="position:absolute; top:100%; left:0; z-index:9999; background:#fff; border:1px solid #ddd; width:100%; max-height:220px; overflow:auto; box-shadow:0 6px 16px rgba(0,0,0,0.1)">${items}</div>` : `<div style="background:#fff; border:1px solid #ddd; padding:8px">No results. Type a more specific place.</div>`;
      list.querySelectorAll('.item').forEach(el => {
        // mousedown triggers earlier than click for snappier UX
        el.addEventListener('mousedown', handlePlacePick, { passive: true });
        el.addEventListener('click', handlePlacePick, { passive: true });
      });
    }

    async function handlePlacePick(ev){
      const el = ev.currentTarget;
      const list = document.getElementById('place-list');
      document.getElementById('place').value = el.textContent;
      const lat = parseFloat(el.getAttribute('data-lat'));
      const lon = parseFloat(el.getAttribute('data-lon'));
      document.getElementById('lat').value = lat.toFixed(4);
      document.getElementById('lon').value = lon.toFixed(4);
      // Clear dropdown immediately for perceived speed
      list.innerHTML='';
      // Fire-and-forget timezone fetch; don't block UI
      try {
        const dt = document.getElementById('dt').value;
        fetch(`/api/tz?datetime=${encodeURIComponent(dt)}&lat=${lat}&lon=${lon}`)
          .then(r=>r.json())
          .then(j=>{ if (j.ok) document.getElementById('tz').value = j.data.tz_offset; })
          .catch(()=>{});
      } catch {}
    }

    function onPlaceKey(ev){
      if (ev.key === 'Enter'){
        ev.preventDefault();
        const list = document.getElementById('place-list');
        const first = list.querySelector('.item');
        if (first) first.click(); else applyPlace();
      }
      if (ev.key === 'Escape'){
        document.getElementById('place-list').innerHTML='';
      }
    }

    async function applyPlace(){
      const q = document.getElementById('place').value.trim();
      if (!q) return;
      const list = document.getElementById('place-list');
      try {
        const res = await fetch(`/api/places?q=${encodeURIComponent(q)}`);
        const json = await res.json();
        if (json.ok && json.data && json.data.length){
          const best = json.data[0];
          document.getElementById('place').value = best.name;
          const lat = parseFloat(best.lat);
          const lon = parseFloat(best.lon);
          document.getElementById('lat').value = lat.toFixed(4);
          document.getElementById('lon').value = lon.toFixed(4);
          list.innerHTML='';
          try {
            const dt = document.getElementById('dt').value;
            const tzRes = await fetch(`/api/tz?datetime=${encodeURIComponent(dt)}&lat=${lat}&lon=${lon}`);
            const tzJson = await tzRes.json();
            if (tzJson.ok) document.getElementById('tz').value = tzJson.data.tz_offset;
          } catch {}
        } else {
          list.innerHTML='';
        }
      } catch { list.innerHTML=''; }
    }
      async function applyPlace(){
        const q = document.getElementById('place').value.trim();
        const list = document.getElementById('place-list');
        if (!q || q.length < 3){
          list.innerHTML = `<div style="background:#fff; border:1px solid #ddd; padding:8px">Type at least 3 characters</div>`;
          return;
        }
        // If suggestions are already visible, pick the first instantly
        const first = list.querySelector('.item');
        if (first) { first.dispatchEvent(new Event('mousedown')); return; }
        // Use cache if available for instant response
        const key = q.toLowerCase();
        if (placeCache.has(key) && placeCache.get(key).length){
          const best = placeCache.get(key)[0];
          document.getElementById('place').value = best.name;
          const lat = parseFloat(best.lat);
          const lon = parseFloat(best.lon);
          document.getElementById('lat').value = lat.toFixed(4);
          document.getElementById('lon').value = lon.toFixed(4);
          list.innerHTML='';
          try {
            const dt = document.getElementById('dt').value;
            const tzRes = await fetch(`/api/tz?datetime=${encodeURIComponent(dt)}&lat=${lat}&lon=${lon}`);
            const tzJson = await tzRes.json();
            if (tzJson.ok) document.getElementById('tz').value = tzJson.data.tz_offset;
          } catch {}
          return;
        }
        try {
          const res = await fetch(`/api/places?q=${encodeURIComponent(q)}`);
          const json = await res.json();
          if (json.ok && json.data && json.data.length){
            const best = json.data[0];
            document.getElementById('place').value = best.name;
            const lat = parseFloat(best.lat);
            const lon = parseFloat(best.lon);
            document.getElementById('lat').value = lat.toFixed(4);
            document.getElementById('lon').value = lon.toFixed(4);
            list.innerHTML='';
            try {
              const dt = document.getElementById('dt').value;
              const tzRes = await fetch(`/api/tz?datetime=${encodeURIComponent(dt)}&lat=${lat}&lon=${lon}`);
              const tzJson = await tzRes.json();
              if (tzJson.ok) document.getElementById('tz').value = tzJson.data.tz_offset;
            } catch {}
          } else {
            list.innerHTML = `<div style="background:#fff; border:1px solid #ddd; padding:8px">No results. Try a different name.</div>`;
          }
        } catch {
          list.innerHTML = `<div style="background:#fff; border:1px solid #ddd; padding:8px">Lookup failed. Check connection.</div>`;
        }
      }

    // Collapsible sections functionality
    function toggleSection(sectionId) {
      const section = document.getElementById(`section-${sectionId}`);
      const content = document.getElementById(`${sectionId}-content`);
      const icon = document.getElementById(`${sectionId}-icon`);
      
      section.classList.toggle('section-expanded');
      
      if (section.classList.contains('section-expanded')) {
        content.style.maxHeight = content.scrollHeight + 'px';
      } else {
        content.style.maxHeight = '0';
      }
    }

    function downloadSection(sectionName) {
      const url = `/api/download/${sectionName}`;
      const link = document.createElement('a');
      link.href = url;
      link.download = `astrology_${sectionName}_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function renderAllSections(data) {
      // Show the sections container
      document.getElementById('sections-container').style.display = 'block';
      
      // Render each section
      renderChartSection(data);
      renderPlanetsSection(data);
      renderHousesSection(data);
      renderNakshatrasSection(data);
      renderTransitsSection(data);
      renderMahadashSection(data);
      renderYearlySection(data);
      
      // Update summaries
      updateSectionSummaries(data);
    }

    function renderChartSection(data) {
      const content = document.getElementById('chart-details');
      const birthInfo = data.birth_info || {};
      
      content.innerHTML = `
        <div class="data-grid">
          <div class="data-card">
            <h4>Birth Details</h4>
            <p><strong>Date & Time:</strong> ${new Date(birthInfo.datetime).toLocaleString()}</p>
            <p><strong>Location:</strong> ${birthInfo.latitude}¬∞N, ${birthInfo.longitude}¬∞E</p>
            <p><strong>Timezone:</strong> UTC${birthInfo.timezone_offset >= 0 ? '+' : ''}${birthInfo.timezone_offset} hours</p>
          </div>
          <div class="data-card">
            <h4>Chart Settings</h4>
            <p><strong>Ayanamsa:</strong> ${birthInfo.ayanamsa || 'Lahiri'}</p>
            <p><strong>House System:</strong> ${birthInfo.house_system || 'Equal'}</p>
            <p><strong>Node Type:</strong> ${birthInfo.node_type || 'Mean'}</p>
            <p><strong>Ascendant:</strong> ${data.ascendant?.toFixed(2)}¬∞</p>
          </div>
        </div>
      `;
    }

    function renderPlanetsSection(data) {
      const content = document.getElementById('planets-details');
      const planets = data.planetary_analysis || {};
      
      let planetsHtml = '<table class="data-table"><thead><tr><th>Planet</th><th>Sign</th><th>Degree</th><th>House</th><th>Nakshatra</th><th>Pada</th></tr></thead><tbody>';
      
      Object.entries(planets).forEach(([planet, info]) => {
        const nakshatra = info.nakshatra || {};
        planetsHtml += `
          <tr>
            <td><strong>${planet}</strong></td>
            <td>${info.sign || ''}</td>
            <td>${info.degree_in_sign?.toFixed(2)}¬∞</td>
            <td>${info.house}</td>
            <td>${nakshatra.name || ''}</td>
            <td>${nakshatra.pada || ''}</td>
          </tr>
        `;
      });
      
      planetsHtml += '</tbody></table>';
      content.innerHTML = planetsHtml;
    }

    function renderHousesSection(data) {
      const content = document.getElementById('houses-details');
      const houses = data.house_analysis || {};
      
      let housesHtml = '<table class="data-table"><thead><tr><th>House</th><th>Sign</th><th>Cusp</th><th>Planets</th><th>Significance</th></tr></thead><tbody>';
      
      for (let i = 1; i <= 12; i++) {
        const house = houses[i.toString()] || {};
        const planetsText = house.planets?.join(', ') || 'Empty';
        housesHtml += `
          <tr>
            <td><strong>${i}</strong></td>
            <td>${house.sign || ''}</td>
            <td>${house.cusp_degree?.toFixed(2)}¬∞</td>
            <td>${planetsText}</td>
            <td style="font-size: 0.9rem;">${house.significances || ''}</td>
          </tr>
        `;
      }
      
      housesHtml += '</tbody></table>';
      content.innerHTML = housesHtml;
    }

    function renderNakshatrasSection(data) {
      const content = document.getElementById('nakshatras-details');
      const nakshatras = data.nakshatra_details || {};
      
      let nakshatrasHtml = '<table class="data-table"><thead><tr><th>Planet</th><th>Nakshatra</th><th>Lord</th><th>Pada</th><th>Degree in Nakshatra</th></tr></thead><tbody>';
      
      Object.entries(nakshatras).forEach(([planet, info]) => {
        nakshatrasHtml += `
          <tr>
            <td><strong>${planet}</strong></td>
            <td>${info.nakshatra_name || ''}</td>
            <td>${info.nakshatra_lord || ''}</td>
            <td>${info.pada || ''}</td>
            <td>${info.degree_in_nakshatra?.toFixed(3)}¬∞</td>
          </tr>
        `;
      });
      
      nakshatrasHtml += '</tbody></table>';
      content.innerHTML = nakshatrasHtml;
    }

    function renderTransitsSection(data) {
      const content = document.getElementById('transits-details');
      const transits = data.current_transits || {};
      const transitData = transits.transits || {};
      
      let transitsHtml = `
        <div class="highlight" style="margin-bottom: 1rem;">
          <strong>Transit Calculation Time:</strong> ${new Date(transits.calculation_time).toLocaleString()}
        </div>
        <table class="data-table">
          <thead>
            <tr><th>Planet</th><th>Birth Position</th><th>Current Position</th><th>Current Sign</th><th>Current House</th><th>Movement</th></tr>
          </thead>
          <tbody>
      `;
      
      Object.entries(transitData).forEach(([planet, transit]) => {
        transitsHtml += `
          <tr>
            <td><strong>${planet}</strong></td>
            <td>${transit.birth_longitude?.toFixed(2)}¬∞</td>
            <td>${transit.current_longitude?.toFixed(2)}¬∞</td>
            <td>${transit.current_sign || ''}</td>
            <td>${transit.current_house || ''}</td>
            <td>${transit.degree_difference?.toFixed(1)}¬∞</td>
          </tr>
        `;
      });
      
      transitsHtml += '</tbody></table>';
      content.innerHTML = transitsHtml;
    }

    function renderMahadashSection(data) {
      const content = document.getElementById('mahadasha-details');
      const vim = data.vimshottari || {};
      
      if (!vim.mahadashas) {
        content.innerHTML = '<p>No Vimshottari dasha data available.</p>';
        return;
      }
      
      const lord = vim.nakshatraLord;
      const balY = vim.balanceAtBirthYears || 0;
      const y = Math.floor(balY);
      const remDays = (balY - y) * 365.2425;
      const m = Math.floor(remDays / 30.436875);
      const d = Math.round(remDays - m*30.436875);
      
      const fmtDMY = (iso) => {
        const dt = new Date(iso);
        if (isNaN(dt.getTime())) return iso;
        const dd = String(dt.getDate()).padStart(2,'0');
        const mm = String(dt.getMonth()+1).padStart(2,'0');
        const yyyy = dt.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      };
      
      let dashHtml = `
        <div class="highlight" style="margin-bottom: 1rem;">
          <strong>Nakshatra Lord at birth:</strong> ${lord || ''} ‚Ä¢ 
          <strong>Balance at birth:</strong> ${y}y ${m}m ${d}d
        </div>
        <table class="data-table">
          <thead>
            <tr><th>Dasha Level</th><th>Lord</th><th>Start</th><th>End</th><th>Duration</th></tr>
          </thead>
          <tbody>
      `;
      
      vim.mahadashas.forEach((md, idx) => {
        dashHtml += `
          <tr style="background: #f8f9fa; font-weight: bold;">
            <td>Mahadasha</td>
            <td>${md.lord}</td>
            <td>${fmtDMY(md.start)}</td>
            <td>${fmtDMY(md.end)}</td>
            <td>${md.years}y</td>
          </tr>
        `;
        
        if (idx < 3) { // Show first 3 MDs with details
          md.antardashas?.forEach(ad => {
            dashHtml += `
              <tr style="background: #fafafa;">
                <td style="padding-left: 1rem;">‚Üí Antardasha</td>
                <td>${ad.lord}</td>
                <td>${fmtDMY(ad.start)}</td>
                <td>${fmtDMY(ad.end)}</td>
                <td></td>
              </tr>
            `;
          });
        }
      });
      
      dashHtml += '</tbody></table>';
      content.innerHTML = dashHtml;
    }

    function renderYearlySection(data) {
      const content = document.getElementById('yearly-details');
      const yearly = data.yearly_dasha || {};
      
      if (!Object.keys(yearly).length) {
        content.innerHTML = '<p>No yearly dasha data available.</p>';
        return;
      }
      
      let yearlyHtml = '';
      
      Object.entries(yearly).forEach(([year, yearData]) => {
        const quarters = yearData.quarterly_summary || {};
        
        yearlyHtml += `
          <div class="data-card" style="margin-bottom: 1rem;">
            <h4>üìÖ ${year}</h4>
            <div style="margin: 0.5rem 0;">
              <strong>Total Periods:</strong> ${yearData.total_periods || 0}
            </div>
            <div class="data-grid" style="grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
              <div><strong>Q1 (Jan-Mar):</strong><br>${quarters.Q1 || 'No periods'}</div>
              <div><strong>Q2 (Apr-Jun):</strong><br>${quarters.Q2 || 'No periods'}</div>
              <div><strong>Q3 (Jul-Sep):</strong><br>${quarters.Q3 || 'No periods'}</div>
              <div><strong>Q4 (Oct-Dec):</strong><br>${quarters.Q4 || 'No periods'}</div>
            </div>
          </div>
        `;
      });
      
      content.innerHTML = yearlyHtml;
    }

    function updateSectionSummaries(data) {
      // Update section summaries
      const planetCount = Object.keys(data.planetary_analysis || {}).length;
      document.getElementById('planets-summary').textContent = `${planetCount} planets analyzed with detailed positions`;
      
      const occupiedHouses = Object.values(data.house_analysis || {}).filter(h => h.is_occupied).length;
      document.getElementById('houses-summary').textContent = `${occupiedHouses} houses occupied, 12 total analyzed`;
      
      const nakshatraCount = Object.keys(data.nakshatra_details || {}).length;
      document.getElementById('nakshatras-summary').textContent = `${nakshatraCount} planetary nakshatras calculated`;
      
      const transitTime = data.current_transits?.calculation_time;
      if (transitTime) {
        document.getElementById('transits-summary').textContent = `Current positions as of ${new Date(transitTime).toLocaleDateString()}`;
      }
      
      const totalMDs = data.vimshottari?.mahadashas?.length || 0;
      document.getElementById('mahadasha-summary').textContent = `${totalMDs} mahadashas in 120-year cycle`;
      
      const yearsCovered = Object.keys(data.yearly_dasha || {}).length;
      document.getElementById('yearly-summary').textContent = `${yearsCovered} years of dasha periods calculated`;
    }
  </script>
</body>
</html>