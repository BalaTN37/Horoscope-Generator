<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vedic Astrology Chart</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 2rem; }
    .grid { display: grid; grid-template-columns: 1fr 2fr; gap: 1.5rem; }
    label { display: block; margin-top: 0.5rem; font-weight: 600; }
    input, select { width: 100%; padding: 0.5rem; }
    button { padding: 0.6rem 1rem; margin-top: 1rem; }
    
    /* DateTime Grid Styles */
    .datetime-grid {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fafafa;
    }
    
    .date-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.2rem;
    }
    
    .small-label {
      font-size: 0.7rem;
      color: #666;
      margin: 0;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .date-input, .year-input, .time-input {
      padding: 0.4rem 0.2rem;
      text-align: center;
      font-size: 0.9rem;
      border: 1px solid #ccc;
      border-radius: 3px;
      transition: all 0.2s ease;
      background: white;
      font-weight: 500;
    }
    
    .date-input {
      width: 35px;
    }
    
    .year-input {
      width: 55px;
    }
    
    .time-input {
      width: 35px;
    }
    
    .ampm-select {
      width: 50px;
      padding: 0.4rem 0.2rem;
      text-align: center;
      font-size: 0.85rem;
      border: 1px solid #ccc;
      border-radius: 3px;
      transition: all 0.2s ease;
      background: white;
      font-weight: 500;
    }
    
    .date-input:focus, .year-input:focus, .time-input:focus, .ampm-select:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 1px rgba(0, 123, 255, 0.2);
      background: #fff;
    }
    
    .date-input.error, .year-input.error, .time-input.error {
      border-color: #dc3545;
      background-color: #fff5f5;
    }
    
    .date-separator, .time-separator {
      font-size: 1rem;
      font-weight: 600;
      color: #888;
      margin: 0 0.2rem;
      margin-top: 1rem;
      user-select: none;
    }
    
    .time-separator {
      font-size: 0.8rem;
      color: #999;
      font-style: italic;
      margin: 0 0.4rem;
      margin-top: 1rem;
    }
    pre { background: #f7f7f9; padding: 1rem; overflow: auto; max-height: 300px; }
    canvas { width: 100%; height: 520px; border: 1px solid #ddd; margin-bottom: 1rem; }
    .row { display:flex; gap:1rem; align-items:end }
    
    /* Collapsible Sections */
    .section-container {
      border: 1px solid #ddd;
      border-radius: 8px;
      margin: 1rem 0;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .section-header {
      padding: 1rem;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 8px 8px 0 0;
      transition: background 0.2s ease;
    }
    
    .section-header:hover {
      background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    }
    
    .section-title {
      font-weight: 600;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .section-summary {
      color: #6c757d;
      font-size: 0.9rem;
      margin-left: 1.5rem;
    }
    
    .section-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    
    .download-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    
    .download-btn:hover {
      background: #218838;
    }
    
    .expand-icon {
      font-size: 1.2rem;
      transition: transform 0.2s ease;
      color: #6c757d;
    }
    
    .section-expanded .expand-icon {
      transform: rotate(180deg);
    }
    
    .section-content {
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    
    .section-expanded .section-content {
      max-height: 2000px;
      padding: 1rem;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.5rem 0;
    }
    
    .data-table th,
    .data-table td {
      padding: 0.5rem;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }
    
    .data-table th {
      background: #f8f9fa;
      font-weight: 600;
    }
    
    .data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1rem;
      margin: 0.5rem 0;
    }
    
    .data-card {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 6px;
      border-left: 4px solid #007bff;
    }
    
    .highlight {
      background: #fff3cd;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      border-left: 3px solid #ffc107;
    }
    
    /* South Indian Chart Styles */
    .south-indian-chart {
      width: 400px;
      height: 400px;
      margin: 2rem auto;
      border-collapse: collapse;
      border: 3px solid #2c3e50;
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .south-indian-chart td {
      width: 25%;
      height: 25%;
      border: 1px solid #6c757d;
      text-align: center;
      vertical-align: middle;
      position: relative;
      font-weight: bold;
      font-size: 18px;
      color: #2c3e50;
    }
    
    .south-indian-chart .center-cell {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      color: #6c757d;
      font-size: 14px;
    }
    
    .south-indian-chart .sign-cell {
      background: #ffffff;
      transition: background-color 0.2s ease;
    }
    
    .south-indian-chart .sign-cell:hover {
      background: #f8f9fa;
    }
    
    /* Ascendant highlighting */
    .south-indian-chart .ascendant-cell {
      position: relative;
    }
    
    .south-indian-chart .ascendant-cell::before {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      right: 2px;
      bottom: 2px;
      border: 3px solid #ff6b35;
      border-radius: 50%;
      pointer-events: none;
      z-index: 1;
    }
    
    .south-indian-chart .ascendant-cell .sign-number {
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      color: white;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      position: relative;
      z-index: 2;
    }
    
    /* Planet placement styles */
    .sign-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 2px;
      box-sizing: border-box;
    }
    
    .sign-number {
      font-weight: bold;
      font-size: 14px;
      color: #6c757d;
      margin-bottom: 2px;
    }
    
    .planets-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1px;
      max-height: calc(100% - 20px);
      overflow: hidden;
    }
    
    .planet-item {
      font-size: 12px;
      font-weight: 500;
      color: #2c3e50;
      text-align: center;
      line-height: 1.1;
      white-space: nowrap;
      padding: 1px 2px;
      border-radius: 2px;
      transition: all 0.2s ease;
    }
    
    /* Planet type color coding */
    .planet-item.benefic {
      background: rgba(40, 167, 69, 0.1);
      color: #155724;
    }
    
    .planet-item.malefic {
      background: rgba(220, 53, 69, 0.1);
      color: #721c24;
    }
    
    .planet-item.luminary {
      background: rgba(255, 193, 7, 0.1);
      color: #856404;
    }
    
    /* Dynamic font sizing for multiple planets */
    .planets-container.size-1 .planet-item { font-size: 12px; }
    .planets-container.size-2 .planet-item { font-size: 11px; }
    .planets-container.size-3 .planet-item { font-size: 10px; }
    .planets-container.size-4plus .planet-item { font-size: 9px; }
    
    /* Hover effects for planets */
    .planet-item:hover {
      transform: scale(1.05);
      z-index: 10;
      position: relative;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    /* Responsive chart */
    @media (max-width: 768px) {
      .south-indian-chart {
        width: 320px;
        height: 320px;
      }
      
      .south-indian-chart td {
        font-size: 16px;
      }
      
      .south-indian-chart .center-cell {
        font-size: 12px;
      }
    }
    
    /* Shadbala Strength Styling */
    .strength-badge {
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .strength-badge-excellent {
      background: #28a745;
      color: white;
    }
    
    .strength-badge-strong {
      background: #20c997;
      color: white;
    }
    
    .strength-badge-good {
      background: #ffc107;
      color: #212529;
    }
    
    .strength-badge-average {
      background: #17a2b8;
      color: white;
    }
    
    .strength-badge-weak {
      background: #dc3545;
      color: white;
    }
    
    /* UchchaBala specific styling */
    .uchcha-badge {
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .uchcha-badge-excellent {
      background: #d1f2eb;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .uchcha-badge-strong {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .uchcha-badge-good {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .uchcha-badge-average {
      background: #e2e3e5;
      color: #495057;
      border: 1px solid #d6d8db;
    }
    
    .uchcha-badge-weak {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .uchcha-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .uchcha-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* SaptavarigiyaBala specific styling */
    .saptavargiya-badge {
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .saptavargiya-badge-excellent {
      background: #4caf50;
      color: white;
    }
    
    .saptavargiya-badge-strong {
      background: #8bc34a;
      color: white;
    }
    
    .saptavargiya-badge-good {
      background: #ff9800;
      color: white;
    }
    
    .saptavargiya-badge-average {
      background: #2196f3;
      color: white;
    }
    
    .saptavargiya-badge-weak {
      background: #f44336;
      color: white;
    }
    
    .saptavargiya-card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .saptavargiya-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .strength-row-excellent {
      background: rgba(40, 167, 69, 0.1);
    }
    
    .strength-row-strong {
      background: rgba(32, 201, 151, 0.1);
    }
    
    .strength-row-good {
      background: rgba(255, 193, 7, 0.1);
    }
    
    .strength-row-average {
      background: rgba(23, 162, 184, 0.1);
    }
    
    .strength-row-weak {
      background: rgba(220, 53, 69, 0.1);
    }
    
    /* Divisional Charts Styling */
    .divisional-charts-container {
      margin-top: 1rem;
    }
    
    .chart-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 0.5rem;
    }
    
    .chart-tab-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
      font-size: 0.9rem;
    }
    
    .chart-tab-btn:hover {
      background: #007bff !important;
      color: white !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    }
    
    .chart-tab-btn.active {
      background: #007bff;
      color: white;
    }
    
    .chart-content {
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .divisional-chart-grid {
      margin-bottom: 2rem;
    }
    
    .divisional-chart-grid .south-indian-chart {
      margin: 0 auto;
      max-width: 600px;
    }
    
    .divisional-chart-grid .planet-marker {
      background: #6c757d;
      color: white;
      padding: 1px 3px;
      border-radius: 3px;
      font-size: 0.7rem;
      font-weight: bold;
      line-height: 1;
      min-width: 16px;
      text-align: center;
      margin: 1px;
      display: inline-block;
    }
    
    .positions-table-container {
      margin-top: 1.5rem;
    }
    
    .positions-table-container table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }
    
    .positions-table-container th,
    .positions-table-container td {
      border: 1px solid #dee2e6;
      padding: 0.5rem;
      text-align: left;
    }
    
    .positions-table-container thead {
      background: #e9ecef;
    }
    
    @media (max-width: 768px) {
      .chart-tabs {
        flex-direction: column;
      }
      
      .chart-tab-btn {
        text-align: center;
      }
      
      .divisional-chart-grid .south-indian-chart {
        font-size: 0.8rem;
      }
      
      .positions-table-container {
        overflow-x: auto;
      }
    }
  </style>
</head>
<body>
  <h1>Vedic Astrology Chart</h1>
  <div class="grid">
    <div>
      <label>Place</label>
      <div class="row" style="align-items:center; gap:0.5rem; position:relative">
        <input id="place" type="text" placeholder="City, State, Country" autocomplete="off" autocapitalize="off" spellcheck="false" oninput="onPlaceInput()" onkeydown="onPlaceKey(event)" style="flex:1" />
        <button type="button" onclick="applyPlace()">Find</button>
        <div id="place-list" style="position:absolute; top:100%; left:0; right:0; z-index:9999"></div>
      </div>
      <label>Date & Time (local)</label>
      <div class="datetime-grid">
        <div class="date-group">
          <label class="small-label">Day</label>
          <input id="day" type="number" min="1" max="31" placeholder="DD" class="date-input" oninput="handleDateFieldInput('day')" onkeydown="handleDateFieldKey(event, 'day')" />
        </div>
        <div class="date-separator">/</div>
        <div class="date-group">
          <label class="small-label">Month</label>
          <input id="month" type="number" min="1" max="12" placeholder="MM" class="date-input" oninput="handleDateFieldInput('month')" onkeydown="handleDateFieldKey(event, 'month')" />
        </div>
        <div class="date-separator">/</div>
        <div class="date-group">
          <label class="small-label">Year</label>
          <input id="year" type="number" min="1900" max="2100" placeholder="YYYY" class="year-input" oninput="handleDateFieldInput('year')" onkeydown="handleDateFieldKey(event, 'year')" />
        </div>
        <div class="time-separator">at</div>
        <div class="date-group">
          <label class="small-label">Hour</label>
          <input id="hour" type="number" min="1" max="12" placeholder="HH" class="time-input" oninput="handleDateFieldInput('hour')" onkeydown="handleDateFieldKey(event, 'hour')" />
        </div>
        <div class="date-separator">:</div>
        <div class="date-group">
          <label class="small-label">Min</label>
          <input id="minute" type="number" min="0" max="59" placeholder="MM" class="time-input" oninput="handleDateFieldInput('minute')" onkeydown="handleDateFieldKey(event, 'minute')" />
        </div>
        <div class="date-group">
          <label class="small-label">Period</label>
          <select id="ampm" class="ampm-select" onchange="handleDateFieldInput('ampm')" onkeydown="handleDateFieldKey(event, 'ampm')">
            <option value="">--</option>
            <option value="AM">AM</option>
            <option value="PM">PM</option>
          </select>
        </div>
      </div>
      <input id="dt" type="datetime-local" style="display:none;" />
      <label>Latitude</label>
      <input id="lat" type="number" step="0.0001" placeholder="e.g. 28.6139" />
      <label>Longitude</label>
      <input id="lon" type="number" step="0.0001" placeholder="e.g. 77.2090" />
      <div class="row">
        <div style="flex:1">
          <label>Timezone offset (hours)</label>
          <input id="tz" type="number" step="0.25" placeholder="e.g. 5.5" />
        </div>
        <div></div>
      </div>
      <label>Ayanamsa</label>
      <select id="ayan">
        <option value="lahiri" selected>Lahiri (default)</option>
        <option value="krishnamurti">Krishnamurti</option>
      </select>
      <label>House system</label>
      <select id="house">
        <option value="equal" selected>Equal (default)</option>
        <option value="whole">Whole Sign</option>
        <option value="placidus">Placidus</option>
        <option value="koch">Koch</option>
        <option value="porphyry">Porphyry</option>
      </select>
      <label>Node type</label>
      <select id="nodeType">
        <option value="mean" selected>Mean (default)</option>
        <option value="true">True</option>
      </select>
      <button onclick="submitForm()">Generate</button>
      <div id="err" style="color:crimson; margin-top:0.5rem"></div>
    </div>
    <div id="results-container">
      <!-- Canvas chart replaced by table-based chart in collapsible sections -->
      <!-- <canvas id="chart"></canvas> -->
      
      <!-- Collapsible Sections -->
      <div id="sections-container" style="display: none;">
        
        <!-- Birth Chart Overview Section -->
        <div class="section-container" id="section-chart">
          <div class="section-header" onclick="toggleSection('chart')">
            <div>
              <div class="section-title">
                <span>üéØ</span>Birth Chart Overview
              </div>
              <div class="section-summary" id="chart-summary">Chart details and basic information</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('birth_info')" title="Download birth info as JSON">üì• JSON</button>
              <span class="expand-icon" id="chart-icon">‚ñº</span>
            </div>
          </div>
          <div class="section-content" id="chart-content">
            <!-- South Indian Chart Table -->
            <table class="south-indian-chart">
              <!-- Row 1: 12, 1, 2, 3 -->
              <tr>
                <td class="sign-cell" data-sign="12" id="sign-12">
                  <div class="sign-content">
                    <div class="sign-number">12</div>
                    <div class="planets-container" id="planets-12"></div>
                  </div>
                </td>
                <td class="sign-cell" data-sign="1" id="sign-1">
                  <div class="sign-content">
                    <div class="sign-number">1</div>
                    <div class="planets-container" id="planets-1"></div>
                  </div>
                </td>
                <td class="sign-cell" data-sign="2" id="sign-2">
                  <div class="sign-content">
                    <div class="sign-number">2</div>
                    <div class="planets-container" id="planets-2"></div>
                  </div>
                </td>
                <td class="sign-cell" data-sign="3" id="sign-3">
                  <div class="sign-content">
                    <div class="sign-number">3</div>
                    <div class="planets-container" id="planets-3"></div>
                  </div>
                </td>
              </tr>
              <!-- Row 2: 11, center, center, 4 -->
              <tr>
                <td class="sign-cell" data-sign="11" id="sign-11">
                  <div class="sign-content">
                    <div class="sign-number">11</div>
                    <div class="planets-container" id="planets-11"></div>
                  </div>
                </td>
                <td class="center-cell">RASI<br><small>Chart</small></td>
                <td class="center-cell">
                  <div style="font-size: 12px; font-weight: bold; color: #2c3e50;">ASC</div>
                  <div id="asc-sign-display" style="font-size: 11px; font-weight: 600; color: #ff6b35; margin: 2px 0;">--</div>
                  <div id="asc-display" style="font-size: 10px; color: #6c757d;">--¬∞</div>
                  <div id="asc-planets-display" style="font-size: 9px; color: #28a745; margin-top: 2px; line-height: 1.1;"></div>
                </td>
                <td class="sign-cell" data-sign="4" id="sign-4">
                  <div class="sign-content">
                    <div class="sign-number">4</div>
                    <div class="planets-container" id="planets-4"></div>
                  </div>
                </td>
              </tr>
              <!-- Row 3: 10, center, center, 5 -->
              <tr>
                <td class="sign-cell" data-sign="10" id="sign-10">
                  <div class="sign-content">
                    <div class="sign-number">10</div>
                    <div class="planets-container" id="planets-10"></div>
                  </div>
                </td>
                <td class="center-cell">SOUTH<br><small>Indian</small></td>
                <td class="center-cell">STYLE</td>
                <td class="sign-cell" data-sign="5" id="sign-5">
                  <div class="sign-content">
                    <div class="sign-number">5</div>
                    <div class="planets-container" id="planets-5"></div>
                  </div>
                </td>
              </tr>
              <!-- Row 4: 9, 8, 7, 6 -->
              <tr>
                <td class="sign-cell" data-sign="9" id="sign-9">
                  <div class="sign-content">
                    <div class="sign-number">9</div>
                    <div class="planets-container" id="planets-9"></div>
                  </div>
                </td>
                <td class="sign-cell" data-sign="8" id="sign-8">
                  <div class="sign-content">
                    <div class="sign-number">8</div>
                    <div class="planets-container" id="planets-8"></div>
                  </div>
                </td>
                <td class="sign-cell" data-sign="7" id="sign-7">
                  <div class="sign-content">
                    <div class="sign-number">7</div>
                    <div class="planets-container" id="planets-7"></div>
                  </div>
                </td>
                <td class="sign-cell" data-sign="6" id="sign-6">
                  <div class="sign-content">
                    <div class="sign-number">6</div>
                    <div class="planets-container" id="planets-6"></div>
                  </div>
                </td>
              </tr>
            </table>
            <div id="chart-details"></div>
          </div>
        </div>
        
        <!-- Planetary Positions Section -->
        <div class="section-container" id="section-planets">
          <div class="section-header" onclick="toggleSection('planets')">
            <div>
              <div class="section-title">
                <span>ü™ê</span>Planetary Positions
              </div>
              <div class="section-summary" id="planets-summary">Detailed planetary analysis</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('planets')" title="Download planetary data as JSON">üì• JSON</button>
              <span class="expand-icon" id="planets-icon">‚ñº</span>
            </div>
          </div>
          <div class="section-content" id="planets-content">
            <div id="planets-details"></div>
          </div>
        </div>
        
        <!-- Divisional Charts Section -->
        <div class="section-container" id="section-divisional-charts">
          <div class="section-header" onclick="toggleSection('divisional-charts')">
            <div>
              <div class="section-title">
                <span>üìä</span>Divisional Charts
              </div>
              <div class="section-summary" id="divisional-charts-summary">Varga charts (D2, D3, D7, D9, D12, D30)</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('divisional_charts')" title="Download Divisional Charts as JSON">üì• JSON</button>
              <span class="expand-icon" id="divisional-charts-icon">‚ñº</span>
            </div>
          </div>
          <div class="section-content" id="divisional-charts-content">
            <div id="divisional-charts-details"></div>
          </div>
        </div>
        
        <!-- Panchadha Maitri Section -->
        <div class="section-container" id="section-panchadha-maitri">
          <div class="section-header" onclick="toggleSection('panchadha-maitri')">
            <div>
              <div class="section-title">
                <span>ü§ù</span>Panchadha Maitri Tables
              </div>
              <div class="section-summary" id="panchadha-maitri-summary">Five-fold friendship analysis</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('panchadha_maitri')" title="Download Panchadha Maitri as JSON">üì• JSON</button>
              <span class="expand-icon" id="panchadha-maitri-icon">‚ñº</span>
            </div>
          </div>
          <div class="section-content" id="panchadha-maitri-content">
            <div id="panchadha-maitri-details"></div>
          </div>
        </div>
        
        <!-- Shadbala Strength Analysis Section -->
        <div class="section-container" id="section-shadbala">
          <div class="section-header" onclick="toggleSection('shadbala')">
            <div>
              <div class="section-title">
                <span>‚ö°</span>Shadbala Strength Analysis
              </div>
              <div class="section-summary" id="shadbala-summary">Planetary strength scores</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('shadbala')" title="Download Shadbala data as JSON">üì• JSON</button>
              <span class="expand-icon" id="shadbala-icon">‚ñº</span>
            </div>
          </div>
          <div class="section-content" id="shadbala-content">
            <div id="shadbala-details"></div>
          </div>
        </div>
        
        <!-- Shadbala Calculator Section -->
        <div class="section-container" id="section-shadbala-calculator">
          <div class="section-header" onclick="toggleSection('shadbala-calculator')">
            <div>
              <div class="section-title">
                <span>üßÆ</span>Shadbala Calculator
              </div>
              <div class="section-summary" id="shadbala-calculator-summary">Detailed strength component analysis</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('shadbala-calculator')" title="Download detailed Shadbala calculations as JSON">üì• JSON</button>
              <span class="expand-icon" id="shadbala-calculator-icon">‚ñº</span>
            </div>
          </div>
          <div class="section-content" id="shadbala-calculator-content">
            <div id="shadbala-calculator-details"></div>
          </div>
        </div>

        <!-- House Analysis Section -->
        <div class="section-container" id="section-houses">
          <div class="section-header" onclick="toggleSection('houses')">
            <div>
              <div class="section-title">
                <span>üè†</span>House Analysis
              </div>
              <div class="section-summary" id="houses-summary">House cusps and significances</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('houses')" title="Download house data as JSON">üì• JSON</button>
              <span class="expand-icon" id="houses-icon">‚ñº</span>
            </div>
          </div>
          <div class="section-content" id="houses-content">
            <div id="houses-details"></div>
          </div>
        </div>
        
        <!-- Nakshatra Analysis Section -->
        <div class="section-container" id="section-nakshatras">
          <div class="section-header" onclick="toggleSection('nakshatras')">
            <div>
              <div class="section-title">
                <span>üåü</span>Nakshatra Analysis
              </div>
              <div class="section-summary" id="nakshatras-summary">Detailed nakshatra positions</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('nakshatras')" title="Download nakshatra data as JSON">üì• JSON</button>
              <span class="expand-icon" id="nakshatras-icon">‚ñº</span>
            </div>
          </div>
          <div class="section-content" id="nakshatras-content">
            <div id="nakshatras-details"></div>
          </div>
        </div>
        
        <!-- Current Transits Section -->
        <div class="section-container" id="section-transits">
          <div class="section-header" onclick="toggleSection('transits')">
            <div>
              <div class="section-title">
                <span>üîÑ</span>Current Transits
              </div>
              <div class="section-summary" id="transits-summary">Current planetary positions vs birth chart</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('transits')" title="Download transit data as JSON">üì• JSON</button>
              <span class="expand-icon" id="transits-icon">‚ñº</span>
            </div>
          </div>
          <div class="section-content" id="transits-content">
            <div id="transits-details"></div>
          </div>
        </div>
        
        <!-- Vimshottari Dasha Section -->
        <div class="section-container" id="section-mahadasha">
          <div class="section-header" onclick="toggleSection('mahadasha')">
            <div>
              <div class="section-title">
                <span>‚è∞</span>Vimshottari Dasha
              </div>
              <div class="section-summary" id="mahadasha-summary">120-year dasha timeline</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('mahadasha')" title="Download dasha data as JSON">üì• JSON</button>
              <span class="expand-icon" id="mahadasha-icon">‚ñº</span>
            </div>
          </div>
          <div class="section-content" id="mahadasha-content">
            <div id="mahadasha-details"></div>
          </div>
        </div>
        
        <!-- Yearly Dasha Calendar Section -->
        <div class="section-container" id="section-yearly">
          <div class="section-header" onclick="toggleSection('yearly')">
            <div>
              <div class="section-title">
                <span>üìÖ</span>Yearly Dasha Calendar
              </div>
              <div class="section-summary" id="yearly-summary">Year-by-year dasha breakdown</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('yearly_dasha')" title="Download yearly calendar as JSON">üì• JSON</button>
              <span class="expand-icon" id="yearly-icon">‚ñº</span>
            </div>
          </div>
          <div class="section-content" id="yearly-content">
            <div id="yearly-details"></div>
          </div>
        </div>
        
        <!-- Complete Data Download -->
        <div class="section-container" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
          <div class="section-header" style="background: transparent; cursor: default;">
            <div>
              <div class="section-title">
                <span>üíæ</span>Complete Chart Data
              </div>
              <div class="section-summary">Download all data in one AI-readable JSON file</div>
            </div>
            <div class="section-controls">
              <button class="download-btn" onclick="downloadSection('complete')" style="background: #1976d2;" title="Download complete chart as JSON">üì• Complete JSON</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Legacy output (hidden by default) -->
      <details style="margin-top: 1rem;">
        <summary style="cursor: pointer; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">üîç Raw Data (for debugging)</summary>
        <pre id="out" style="margin-top: 0.5rem;"></pre>
      </details>
    </div>
  </div>

  <script>
    // Canvas chart replaced by table-based chart
    // const canvas = document.getElementById('chart');
    // const ctx = canvas.getContext('2d');
    // Prefill local datetime and timezone offset (in hours)
    (function prefillDefaults(){
      try {
        prefillDateTimeFields();
        const tzHours = -new Date().getTimezoneOffset()/60; // e.g., IST => 5.5
        document.getElementById('tz').value = tzHours;
      } catch {}
    })();

    // Helper function to get planet short text forms
    function getPlanetSymbol(planetName) {
      const shortForms = {
        'Sun': 'Su',
        'Moon': 'Mo', 
        'Mars': 'Ma',
        'Mercury': 'Me',
        'Jupiter': 'Ju',
        'Venus': 'Ve',
        'Saturn': 'Sa',
        'Rahu': 'Ra',
        'Ketu': 'Ke'
      };
      return shortForms[planetName] || planetName.substring(0, 2);
    }
    
    // Helper function to get planet display name (uses short text forms by default)
    function getPlanetDisplayName(planetName, useSymbols = false) {
      // Always use short text forms now
      return getPlanetSymbol(planetName);
    }
    
    // Helper function to get planet type for styling
    function getPlanetType(planetName) {
      const luminaries = ['Sun', 'Moon'];
      const benefics = ['Venus', 'Jupiter', 'Mercury'];
      const malefics = ['Mars', 'Saturn', 'Rahu', 'Ketu'];
      
      if (luminaries.includes(planetName)) return 'luminary';
      if (benefics.includes(planetName)) return 'benefic';
      if (malefics.includes(planetName)) return 'malefic';
      return '';
    }
    
    // Helper function to map signs to chart positions (zodiac signs 1-12)
    function getSignFromZodiacName(zodiacName) {
      const zodiacToNumber = {
        'Aries': 1, 'Taurus': 2, 'Gemini': 3, 'Cancer': 4,
        'Leo': 5, 'Virgo': 6, 'Libra': 7, 'Scorpio': 8,
        'Sagittarius': 9, 'Capricorn': 10, 'Aquarius': 11, 'Pisces': 12
      };
      return zodiacToNumber[zodiacName] || null;
    }
    
    // Field navigation order
    const fieldOrder = ['day', 'month', 'year', 'hour', 'minute', 'ampm'];
    
    // Handle individual date/time field input with auto-navigation
    function handleDateFieldInput(fieldId) {
      const field = document.getElementById(fieldId);
      let value = field.value;
      
      // Auto-advance logic based on field type and value length
      let shouldAdvance = false;
      
      switch (fieldId) {
        case 'day':
          if (value.length === 2 || (value.length === 1 && parseInt(value) > 3)) {
            shouldAdvance = true;
          }
          break;
        case 'month':
          if (value.length === 2 || (value.length === 1 && parseInt(value) > 1)) {
            shouldAdvance = true;
          }
          break;
        case 'year':
          if (value.length === 4) {
            shouldAdvance = true;
          }
          break;
        case 'hour':
          if (value.length === 2 || (value.length === 1 && parseInt(value) > 1)) {
            shouldAdvance = true;
          }
          break;
        case 'minute':
          if (value.length === 2 || (value.length === 1 && parseInt(value) > 5)) {
            shouldAdvance = true;
          }
          break;
      }
      
      // Move to next field if conditions are met
      if (shouldAdvance) {
        moveToNextField(fieldId);
      }
      
      // Validate and update hidden field
      validateAndUpdateDateTime();
    }
    
    // Handle keyboard navigation
    function handleDateFieldKey(event, fieldId) {
      const field = document.getElementById(fieldId);
      
      if (event.key === 'Tab') {
        return; // Let default tab behavior work
      }
      
      if (event.key === 'Enter') {
        event.preventDefault();
        moveToNextField(fieldId);
        return;
      }
      
      if (event.key === 'Backspace' && field.value === '' && field.selectionStart === 0) {
        event.preventDefault();
        moveToPreviousField(fieldId);
        return;
      }
      
      if (event.key === 'ArrowRight' && field.selectionStart === field.value.length) {
        event.preventDefault();
        moveToNextField(fieldId);
        return;
      }
      
      if (event.key === 'ArrowLeft' && field.selectionStart === 0) {
        event.preventDefault();
        moveToPreviousField(fieldId);
        return;
      }
    }
    
    // Move to next field in sequence
    function moveToNextField(currentFieldId) {
      const currentIndex = fieldOrder.indexOf(currentFieldId);
      if (currentIndex >= 0 && currentIndex < fieldOrder.length - 1) {
        const nextFieldId = fieldOrder[currentIndex + 1];
        const nextField = document.getElementById(nextFieldId);
        if (nextField) {
          nextField.focus();
          if (nextField.select) nextField.select();
        }
      }
    }
    
    // Move to previous field in sequence
    function moveToPreviousField(currentFieldId) {
      const currentIndex = fieldOrder.indexOf(currentFieldId);
      if (currentIndex > 0) {
        const prevFieldId = fieldOrder[currentIndex - 1];
        const prevField = document.getElementById(prevFieldId);
        if (prevField) {
          prevField.focus();
          if (prevField.select) prevField.select();
        }
      }
    }
    
    // Validate all fields and update hidden datetime field
    function validateAndUpdateDateTime() {
      const day = document.getElementById('day').value;
      const month = document.getElementById('month').value;
      const year = document.getElementById('year').value;
      const hour = document.getElementById('hour').value;
      const minute = document.getElementById('minute').value;
      const ampm = document.getElementById('ampm').value;
      
      // Clear previous error states
      fieldOrder.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        field.classList.remove('error');
      });
      
      // Check if all fields have values
      if (!day || !month || !year || !hour || !minute || !ampm) {
        return; // Don't validate incomplete data
      }
      
      // Validate ranges
      let isValid = true;
      const dayNum = parseInt(day);
      const monthNum = parseInt(month);
      const yearNum = parseInt(year);
      const hourNum = parseInt(hour);
      const minuteNum = parseInt(minute);
      
      if (dayNum < 1 || dayNum > 31) {
        document.getElementById('day').classList.add('error');
        isValid = false;
      }
      
      if (monthNum < 1 || monthNum > 12) {
        document.getElementById('month').classList.add('error');
        isValid = false;
      }
      
      if (yearNum < 1900 || yearNum > 2100) {
        document.getElementById('year').classList.add('error');
        isValid = false;
      }
      
      if (hourNum < 1 || hourNum > 12) {
        document.getElementById('hour').classList.add('error');
        isValid = false;
      }
      
      if (minuteNum < 0 || minuteNum > 59) {
        document.getElementById('minute').classList.add('error');
        isValid = false;
      }
      
      if (!isValid) return;
      
      // Convert to 24-hour format
      let hour24 = hourNum;
      if (ampm === 'PM' && hourNum !== 12) {
        hour24 += 12;
      } else if (ampm === 'AM' && hourNum === 12) {
        hour24 = 0;
      }
      
      // Create date and validate it exists
      const testDate = new Date(yearNum, monthNum - 1, dayNum, hour24, minuteNum);
      if (testDate.getFullYear() !== yearNum || 
          testDate.getMonth() !== monthNum - 1 || 
          testDate.getDate() !== dayNum) {
        document.getElementById('day').classList.add('error');
        document.getElementById('month').classList.add('error');
        return;
      }
      
      // Update hidden field with ISO format
      const dayStr = String(dayNum).padStart(2, '0');
      const monthStr = String(monthNum).padStart(2, '0');
      const hour24Str = String(hour24).padStart(2, '0');
      const minuteStr = String(minuteNum).padStart(2, '0');
      
      const isoFormat = `${yearNum}-${monthStr}-${dayStr}T${hour24Str}:${minuteStr}`;
      document.getElementById('dt').value = isoFormat;
    }
    
    // Prefill the separate date/time fields with current date/time
    function prefillDateTimeFields() {
      const now = new Date();
      
      document.getElementById('day').value = now.getDate();
      document.getElementById('month').value = now.getMonth() + 1;
      document.getElementById('year').value = now.getFullYear();
      
      let hour12 = now.getHours();
      const ampm = hour12 >= 12 ? 'PM' : 'AM';
      
      if (hour12 > 12) {
        hour12 -= 12;
      } else if (hour12 === 0) {
        hour12 = 12;
      }
      
      document.getElementById('hour').value = hour12;
      document.getElementById('minute').value = String(now.getMinutes()).padStart(2, '0');
      document.getElementById('ampm').value = ampm;
      
      // Update hidden field
      validateAndUpdateDateTime();
    }
    
    // Update South Indian chart table with planet data
    function drawChart(data) {
      console.log('Drawing chart with data:', data);
      
      // Update ascendant display with degree and sign
      const ascDisplay = document.getElementById('asc-display');
      const ascSignDisplay = document.getElementById('asc-sign-display');
      const ascPlanetsDisplay = document.getElementById('asc-planets-display');
      
      if (ascDisplay && data.ascendant) {
        ascDisplay.textContent = data.ascendant.toFixed(1) + '¬∞';
        
        // Calculate and display the ascendant sign
        const ascendantSign = Math.floor(data.ascendant / 30) + 1;
        const degreeInSign = data.ascendant % 30;
        const signNames = ['Ari', 'Tau', 'Gem', 'Can', 'Leo', 'Vir', 'Lib', 'Sco', 'Sag', 'Cap', 'Aqu', 'Pis'];
        const signName = signNames[ascendantSign - 1];
        
        if (ascSignDisplay) {
          ascSignDisplay.textContent = `${signName} ${degreeInSign.toFixed(1)}¬∞`;
        }
        
        // Find and display planets in the ascendant sign
        if (ascPlanetsDisplay && data.planets) {
          const planetsInAscSign = [];
          
          Object.entries(data.planets).forEach(([planetName, planetData]) => {
            const planetSignNumber = getSignFromZodiacName(planetData.sign);
            if (planetSignNumber === ascendantSign) {
              planetsInAscSign.push(getPlanetSymbol(planetName));
            }
          });
          
          if (planetsInAscSign.length > 0) {
            ascPlanetsDisplay.textContent = `With: ${planetsInAscSign.join(', ')}`;
            ascPlanetsDisplay.title = `Planets in ascendant sign: ${planetsInAscSign.join(', ')}`;
          } else {
            ascPlanetsDisplay.textContent = 'No planets';
            ascPlanetsDisplay.title = 'No other planets in ascendant sign';
          }
        }
      }
      
      // Clear all existing planets from chart and remove ascendant highlighting
      for (let i = 1; i <= 12; i++) {
        const container = document.getElementById(`planets-${i}`);
        const signCell = document.getElementById(`sign-${i}`);
        if (container) {
          container.innerHTML = '';
          container.className = 'planets-container';
        }
        if (signCell) {
          signCell.classList.remove('ascendant-cell');
        }
      }
      
      // Highlight ascendant sign
      if (data.ascendant) {
        const ascendantSign = Math.floor(data.ascendant / 30) + 1; // Convert degree to sign number (1-12)
        const ascendantCell = document.getElementById(`sign-${ascendantSign}`);
        if (ascendantCell) {
          ascendantCell.classList.add('ascendant-cell');
          console.log(`Ascendant highlighted in sign ${ascendantSign} at ${data.ascendant.toFixed(1)}¬∞`);
        }
      }
      
      // Place planets by zodiac sign
      if (data.planets) {
        console.log('Placing planets by zodiac signs:', data.planets);
        
        // Group planets by their zodiac signs
        const planetsBySign = {};
        
        Object.entries(data.planets).forEach(([planetName, planetData]) => {
          const signNumber = getSignFromZodiacName(planetData.sign);
          if (signNumber) {
            if (!planetsBySign[signNumber]) {
              planetsBySign[signNumber] = [];
            }
            planetsBySign[signNumber].push({
              name: planetName,
              data: planetData
            });
          }
        });
        
        // Place planets in their respective sign containers
        Object.entries(planetsBySign).forEach(([signNumber, planets]) => {
          const container = document.getElementById(`planets-${signNumber}`);
          if (container) {
            // Add size class for dynamic font scaling
            const sizeClass = planets.length === 1 ? 'size-1' :
                            planets.length === 2 ? 'size-2' :
                            planets.length === 3 ? 'size-3' : 'size-4plus';
            container.className = `planets-container ${sizeClass}`;
            
            planets.forEach(planet => {
              const planetElement = document.createElement('div');
              planetElement.className = `planet-item ${getPlanetType(planet.name)}`;
              
              // Use symbols for better visual appeal
              planetElement.textContent = getPlanetDisplayName(planet.name, true);
              
              // Add tooltip with full planet info
              planetElement.title = `${planet.name} in ${planet.data.sign} (${planet.data.degInSign.toFixed(1)}¬∞)`;
              
              container.appendChild(planetElement);
            });
          }
        });
        
        console.log('Planets placed by sign:', planetsBySign);
      }
      
      // Fallback: if no planets data but planetsByHouse exists, try to use that
      else if (data.planetsByHouse) {
        console.log('Using planetsByHouse data:', data.planetsByHouse);
        // This would be for house-based placement if needed as fallback
      }
    }

    async function submitForm() {
      const err = document.getElementById('err');
      err.textContent = '';
      const dt = document.getElementById('dt').value;
      const place = document.getElementById('place').value;
      const lat = document.getElementById('lat').value;
      const lon = document.getElementById('lon').value;
      const tz = document.getElementById('tz').value;
      const ayan = document.getElementById('ayan').value;
      const house = document.getElementById('house').value;
      const nodeType = document.getElementById('nodeType').value;
      
      // Enhanced validation
      if (!dt) { err.textContent = 'Please set date/time.'; return; }
      
      // Check if we have either a place OR lat/lon coordinates
      if (!place && (!lat || !lon)) {
        err.textContent = 'Please enter a place name OR provide latitude and longitude coordinates.'; 
        return; 
      }
      
      // If lat/lon provided, validate they are numbers
      if (lat && isNaN(parseFloat(lat))) {
        err.textContent = 'Latitude must be a valid number.'; 
        return; 
      }
      
      if (lon && isNaN(parseFloat(lon))) {
        err.textContent = 'Longitude must be a valid number.'; 
        return; 
      }
      
      // Debug logging
      console.log('DEBUG: Submitting with values:');
      console.log('dt:', dt);
      console.log('place:', place);
      console.log('lat:', lat);
      console.log('lon:', lon);
      console.log('tz:', tz);
      
      try {
        const res = await fetch('/api/chart', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ datetime: dt, place, lat, lon, tz_offset: tz, ayanamsa: ayan, house_system: house, node_type: nodeType })
        });
        const json = await res.json();
        if (!json.ok) throw new Error(json.error || 'Failed');
        drawChart(json.data);
        document.getElementById('out').textContent = JSON.stringify(json.data, null, 2);
        renderAllSections(json.data);
      } catch (e) {
        console.error('DEBUG: Error in submitForm:', e);
        console.error('DEBUG: Full error:', e.message);
        err.textContent = e.message;
      }
    }

    // Simple place autosuggest with caching and fast selection
    let placeTimer;
    const placeCache = new Map(); // q(lower) -> [{name,lat,lon}]
    async function onPlaceInput(){
      const q = document.getElementById('place').value.trim();
      const list = document.getElementById('place-list');
      if (placeTimer) clearTimeout(placeTimer);
      if (q.length < 3) { list.innerHTML=''; return; }
      const key = q.toLowerCase();
      // If cached, show immediately for responsiveness
      if (placeCache.has(key)) {
        renderPlaceList(list, placeCache.get(key));
      } else {
        list.innerHTML = `<div style="background:#fff; border:1px solid #ddd; padding:8px">Searching‚Ä¶</div>`;
      }
      placeTimer = setTimeout(async () => {
        try {
          const res = await fetch(`/api/places?q=${encodeURIComponent(q)}`);
          const json = await res.json();
          if (!json.ok) throw new Error(json.error||'place search failed');
          placeCache.set(key, json.data || []);
          renderPlaceList(list, placeCache.get(key));
        } catch(e) { list.innerHTML=''; }
      }, 120);
    }

    function renderPlaceList(list, data){
      const items = (data||[]).map(i => `<div class="item" data-lat="${i.lat}" data-lon="${i.lon}" style="padding:6px 8px; cursor:pointer; border-bottom:1px solid #eee">${i.name}</div>`).join('');
      list.innerHTML = items ? `<div id="place-dd" style="position:absolute; top:100%; left:0; z-index:9999; background:#fff; border:1px solid #ddd; width:100%; max-height:220px; overflow:auto; box-shadow:0 6px 16px rgba(0,0,0,0.1)">${items}</div>` : `<div style="background:#fff; border:1px solid #ddd; padding:8px">No results. Type a more specific place.</div>`;
      list.querySelectorAll('.item').forEach(el => {
        // mousedown triggers earlier than click for snappier UX
        el.addEventListener('mousedown', handlePlacePick, { passive: true });
        el.addEventListener('click', handlePlacePick, { passive: true });
      });
    }

    async function handlePlacePick(ev){
      const el = ev.currentTarget;
      const list = document.getElementById('place-list');
      document.getElementById('place').value = el.textContent;
      const lat = parseFloat(el.getAttribute('data-lat'));
      const lon = parseFloat(el.getAttribute('data-lon'));
      document.getElementById('lat').value = lat.toFixed(4);
      document.getElementById('lon').value = lon.toFixed(4);
      // Clear dropdown immediately for perceived speed
      list.innerHTML='';
      // Fire-and-forget timezone fetch; don't block UI
      try {
        const dt = document.getElementById('dt').value;
        fetch(`/api/tz?datetime=${encodeURIComponent(dt)}&lat=${lat}&lon=${lon}`)
          .then(r=>r.json())
          .then(j=>{ if (j.ok) document.getElementById('tz').value = j.data.tz_offset; })
          .catch(()=>{});
      } catch {}
    }

    function onPlaceKey(ev){
      if (ev.key === 'Enter'){
        ev.preventDefault();
        const list = document.getElementById('place-list');
        const first = list.querySelector('.item');
        if (first) first.click(); else applyPlace();
      }
      if (ev.key === 'Escape'){
        document.getElementById('place-list').innerHTML='';
      }
    }

    async function applyPlace(){
      const q = document.getElementById('place').value.trim();
      if (!q) return;
      const list = document.getElementById('place-list');
      try {
        const res = await fetch(`/api/places?q=${encodeURIComponent(q)}`);
        const json = await res.json();
        if (json.ok && json.data && json.data.length){
          const best = json.data[0];
          document.getElementById('place').value = best.name;
          const lat = parseFloat(best.lat);
          const lon = parseFloat(best.lon);
          document.getElementById('lat').value = lat.toFixed(4);
          document.getElementById('lon').value = lon.toFixed(4);
          list.innerHTML='';
          try {
            const dt = document.getElementById('dt').value;
            const tzRes = await fetch(`/api/tz?datetime=${encodeURIComponent(dt)}&lat=${lat}&lon=${lon}`);
            const tzJson = await tzRes.json();
            if (tzJson.ok) document.getElementById('tz').value = tzJson.data.tz_offset;
          } catch {}
        } else {
          list.innerHTML='';
        }
      } catch { list.innerHTML=''; }
    }
      async function applyPlace(){
        const q = document.getElementById('place').value.trim();
        const list = document.getElementById('place-list');
        if (!q || q.length < 3){
          list.innerHTML = `<div style="background:#fff; border:1px solid #ddd; padding:8px">Type at least 3 characters</div>`;
          return;
        }
        // If suggestions are already visible, pick the first instantly
        const first = list.querySelector('.item');
        if (first) { first.dispatchEvent(new Event('mousedown')); return; }
        // Use cache if available for instant response
        const key = q.toLowerCase();
        if (placeCache.has(key) && placeCache.get(key).length){
          const best = placeCache.get(key)[0];
          document.getElementById('place').value = best.name;
          const lat = parseFloat(best.lat);
          const lon = parseFloat(best.lon);
          document.getElementById('lat').value = lat.toFixed(4);
          document.getElementById('lon').value = lon.toFixed(4);
          list.innerHTML='';
          try {
            const dt = document.getElementById('dt').value;
            const tzRes = await fetch(`/api/tz?datetime=${encodeURIComponent(dt)}&lat=${lat}&lon=${lon}`);
            const tzJson = await tzRes.json();
            if (tzJson.ok) document.getElementById('tz').value = tzJson.data.tz_offset;
          } catch {}
          return;
        }
        try {
          const res = await fetch(`/api/places?q=${encodeURIComponent(q)}`);
          const json = await res.json();
          if (json.ok && json.data && json.data.length){
            const best = json.data[0];
            document.getElementById('place').value = best.name;
            const lat = parseFloat(best.lat);
            const lon = parseFloat(best.lon);
            document.getElementById('lat').value = lat.toFixed(4);
            document.getElementById('lon').value = lon.toFixed(4);
            list.innerHTML='';
            try {
              const dt = document.getElementById('dt').value;
              const tzRes = await fetch(`/api/tz?datetime=${encodeURIComponent(dt)}&lat=${lat}&lon=${lon}`);
              const tzJson = await tzRes.json();
              if (tzJson.ok) document.getElementById('tz').value = tzJson.data.tz_offset;
            } catch {}
          } else {
            list.innerHTML = `<div style="background:#fff; border:1px solid #ddd; padding:8px">No results. Try a different name.</div>`;
          }
        } catch {
          list.innerHTML = `<div style="background:#fff; border:1px solid #ddd; padding:8px">Lookup failed. Check connection.</div>`;
        }
      }

    // Collapsible sections functionality
    function toggleSection(sectionId) {
      const section = document.getElementById(`section-${sectionId}`);
      const content = document.getElementById(`${sectionId}-content`);
      const icon = document.getElementById(`${sectionId}-icon`);
      
      section.classList.toggle('section-expanded');
      
      if (section.classList.contains('section-expanded')) {
        content.style.maxHeight = content.scrollHeight + 'px';
      } else {
        content.style.maxHeight = '0';
      }
    }

    function downloadSection(sectionName) {
      const url = `/api/download/${sectionName}`;
      const link = document.createElement('a');
      link.href = url;
      link.download = `astrology_${sectionName}_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function renderAllSections(data) {
      // Store data globally for modal access
      window.lastChartData = data;
      
      // Show the sections container
      document.getElementById('sections-container').style.display = 'block';
      
      // Render each section
      renderChartSection(data);
      renderDivisionalChartsSection(data);
      renderPanchadhaMaitriSection(data);
      renderPlanetsSection(data);
      renderShadbalaSection(data);
      renderShadbalaCalculatorSection(data);
      renderHousesSection(data);
      renderNakshatrasSection(data);
      renderTransitsSection(data);
      renderMahadashSection(data);
      renderYearlySection(data);
      
      // Update summaries
      updateSectionSummaries(data);
    }

    function renderChartSection(data) {
      const content = document.getElementById('chart-details');
      const birthInfo = data.birth_info || {};
      
      content.innerHTML = `
        <div class="data-grid">
          <div class="data-card">
            <h4>Birth Details</h4>
            <p><strong>Date & Time:</strong> ${new Date(birthInfo.datetime).toLocaleString()}</p>
            <p><strong>Location:</strong> ${birthInfo.latitude}¬∞N, ${birthInfo.longitude}¬∞E</p>
            <p><strong>Timezone:</strong> UTC${birthInfo.timezone_offset >= 0 ? '+' : ''}${birthInfo.timezone_offset} hours</p>
          </div>
          <div class="data-card">
            <h4>Chart Settings</h4>
            <p><strong>Ayanamsa:</strong> ${birthInfo.ayanamsa || 'Lahiri'}</p>
            <p><strong>House System:</strong> ${birthInfo.house_system || 'Equal'}</p>
            <p><strong>Node Type:</strong> ${birthInfo.node_type || 'Mean'}</p>
            <p><strong>Ascendant:</strong> ${data.ascendant?.toFixed(2)}¬∞</p>
          </div>
        </div>
      `;
    }

    function renderPlanetsSection(data) {
      const content = document.getElementById('planets-details');
      const planets = data.planetary_analysis || {};
      
      let planetsHtml = '<table class="data-table"><thead><tr><th>Planet</th><th>Sign</th><th>Degree</th><th>House</th><th>Nakshatra</th><th>Pada</th></tr></thead><tbody>';
      
      Object.entries(planets).forEach(([planet, info]) => {
        const nakshatra = info.nakshatra || {};
        planetsHtml += `
          <tr>
            <td><strong>${planet}</strong></td>
            <td>${info.sign || ''}</td>
            <td>${info.degree_in_sign?.toFixed(2)}¬∞</td>
            <td>${info.house}</td>
            <td>${nakshatra.name || ''}</td>
            <td>${nakshatra.pada || ''}</td>
          </tr>
        `;
      });
      
      planetsHtml += '</tbody></table>';
      content.innerHTML = planetsHtml;
    }

    function renderHousesSection(data) {
      const content = document.getElementById('houses-details');
      const houses = data.house_analysis || {};
      
      let housesHtml = '<table class="data-table"><thead><tr><th>House</th><th>Sign</th><th>Cusp</th><th>Planets</th><th>Significance</th></tr></thead><tbody>';
      
      for (let i = 1; i <= 12; i++) {
        const house = houses[i.toString()] || {};
        const planetsText = house.planets?.join(', ') || 'Empty';
        housesHtml += `
          <tr>
            <td><strong>${i}</strong></td>
            <td>${house.sign || ''}</td>
            <td>${house.cusp_degree?.toFixed(2)}¬∞</td>
            <td>${planetsText}</td>
            <td style="font-size: 0.9rem;">${house.significances || ''}</td>
          </tr>
        `;
      }
      
      housesHtml += '</tbody></table>';
      content.innerHTML = housesHtml;
    }

    function renderNakshatrasSection(data) {
      const content = document.getElementById('nakshatras-details');
      const nakshatras = data.nakshatra_details || {};
      
      let nakshatrasHtml = '<table class="data-table"><thead><tr><th>Planet</th><th>Nakshatra</th><th>Lord</th><th>Pada</th><th>Degree in Nakshatra</th></tr></thead><tbody>';
      
      Object.entries(nakshatras).forEach(([planet, info]) => {
        nakshatrasHtml += `
          <tr>
            <td><strong>${planet}</strong></td>
            <td>${info.nakshatra_name || ''}</td>
            <td>${info.nakshatra_lord || ''}</td>
            <td>${info.pada || ''}</td>
            <td>${info.degree_in_nakshatra?.toFixed(3)}¬∞</td>
          </tr>
        `;
      });
      
      nakshatrasHtml += '</tbody></table>';
      content.innerHTML = nakshatrasHtml;
    }

    function renderTransitsSection(data) {
      const content = document.getElementById('transits-details');
      const transits = data.current_transits || {};
      const transitData = transits.transits || {};
      
      let transitsHtml = `
        <div class="highlight" style="margin-bottom: 1rem;">
          <strong>Transit Calculation Time:</strong> ${new Date(transits.calculation_time).toLocaleString()}
        </div>
        <table class="data-table">
          <thead>
            <tr><th>Planet</th><th>Birth Position</th><th>Current Position</th><th>Current Sign</th><th>Current House</th><th>Movement</th></tr>
          </thead>
          <tbody>
      `;
      
      Object.entries(transitData).forEach(([planet, transit]) => {
        transitsHtml += `
          <tr>
            <td><strong>${planet}</strong></td>
            <td>${transit.birth_longitude?.toFixed(2)}¬∞</td>
            <td>${transit.current_longitude?.toFixed(2)}¬∞</td>
            <td>${transit.current_sign || ''}</td>
            <td>${transit.current_house || ''}</td>
            <td>${transit.degree_difference?.toFixed(1)}¬∞</td>
          </tr>
        `;
      });
      
      transitsHtml += '</tbody></table>';
      content.innerHTML = transitsHtml;
    }

    function renderShadbalaSection(data) {
      const content = document.getElementById('shadbala-details');
      const shadbala = data.shadbala?.shadbala_scores || {};
      
      if (!Object.keys(shadbala).length) {
        content.innerHTML = '<p>No Shadbala data available.</p>';
        return;
      }
      
      let shadbalaHtml = `
        <div class="highlight" style="margin-bottom: 1rem; text-align: center;">
          <strong>Shadbala Planetary Strength Analysis</strong><br>
          <small>Six-fold strength calculation measuring planetary power and effectiveness</small>
        </div>
        
        <div class="strength-overview" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
      `;
      
      // Create strength cards for each planet
      Object.entries(shadbala).forEach(([planet, strength]) => {
        const percentage = strength.strength_percentage;
        const category = strength.category;
        
        // Color coding based on strength
        let cardColor = '#f8d7da'; // Weak - red
        let textColor = '#721c24';
        if (percentage >= 100) {
          cardColor = '#d1f2eb'; // Strong - green
          textColor = '#155724';
        } else if (percentage >= 75) {
          cardColor = '#fff3cd'; // Good - yellow
          textColor = '#856404';
        } else if (percentage >= 50) {
          cardColor = '#cce5ff'; // Average - blue
          textColor = '#004085';
        }
        
        shadbalaHtml += `
          <div class="strength-card" style="background: ${cardColor}; color: ${textColor}; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid rgba(0,0,0,0.1);">
            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">${planet}</div>
            <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.3rem;">${percentage.toFixed(0)}%</div>
            <div style="font-size: 0.9rem; margin-bottom: 0.3rem;">${category}</div>
            <div style="font-size: 0.8rem; opacity: 0.8;">
              ${strength.total_shadbala} / ${strength.required_strength}
            </div>
            <div class="strength-bar" style="width: 100%; height: 4px; background: rgba(0,0,0,0.2); border-radius: 2px; margin-top: 0.5rem; overflow: hidden;">
              <div style="width: ${Math.min(100, percentage)}%; height: 100%; background: ${textColor}; transition: width 0.3s ease;"></div>
            </div>
          </div>
        `;
      });
      
      shadbalaHtml += `
        </div>
        
        <table class="data-table">
          <thead>
            <tr>
              <th>Planet</th>
              <th>Total Score</th>
              <th>Percentage</th>
              <th>Category</th>
              <th>Sthana Bala</th>
              <th>Dig Bala</th>
              <th>Kala Bala</th>
              <th>Chesta Bala</th>
              <th>Naisargika</th>
              <th>Drik Bala</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      Object.entries(shadbala).forEach(([planet, strength]) => {
        const components = strength.components;
        const categoryClass = strength.category.toLowerCase().replace(/\s+/g, '-');
        
        // Check if detailed breakdown is available
        const breakdown = strength.sthana_bala_breakdown || {};
        const hasBreakdown = Object.keys(breakdown).length > 0;
        
        shadbalaHtml += `
          <tr class="strength-row-${categoryClass}">
            <td><strong>${planet}</strong></td>
            <td><strong>${strength.total_shadbala}</strong></td>
            <td><strong>${strength.strength_percentage.toFixed(1)}%</strong></td>
            <td><span class="strength-badge strength-badge-${categoryClass}">${strength.category}</span></td>
            <td>
              ${components.sthana_bala}
              ${hasBreakdown ? `<br><small style="color: #666; font-size: 0.75rem;">UchchaBala: ${breakdown.uchcha_bala || 0}</small>` : ''}
            </td>
            <td>${components.dig_bala}</td>
            <td>${components.kala_bala}</td>
            <td>${components.chesta_bala}</td>
            <td>${components.naisargika_bala}</td>
            <td>${components.drik_bala}</td>
          </tr>
        `;
      });
      
      shadbalaHtml += `
          </tbody>
        </table>
        

        
        <div class="strength-legend" style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #007bff;">
          <h4 style="margin: 0 0 0.5rem 0; color: #495057;">Strength Components Explained:</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 0.5rem; font-size: 0.85rem;">
            <div><strong>Sthana Bala:</strong> Positional strength (exaltation, own sign, etc.)</div>
            <div><strong>UchchaBala:</strong> Distance-based strength from debilitation point</div>
            <div><strong>Dig Bala:</strong> Directional strength (angular house placement)</div>
            <div><strong>Kala Bala:</strong> Temporal strength (day/night, lunar phase)</div>
            <div><strong>Chesta Bala:</strong> Motional strength (planetary speed/retrograde)</div>
            <div><strong>Naisargika:</strong> Natural inherent strength of each planet</div>
            <div><strong>Drik Bala:</strong> Aspectual strength (beneficial/malefic aspects)</div>
          </div>
        </div>
      `;
      
      content.innerHTML = shadbalaHtml;
    }

    function renderShadbalaCalculatorSection(data) {
      const content = document.getElementById('shadbala-calculator-details');
      const shadbala = data.shadbala?.shadbala_scores || {};
      
      if (!shadbala || Object.keys(shadbala).length === 0) {
        content.innerHTML = '<p>No Shadbala calculation data available.</p>';
        return;
      }
      
      let calculatorHtml = `
        <div style="margin-bottom: 2rem;">
          <div class="highlight" style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 8px; border-left: 4px solid #2196f3;">
            <h4 style="margin: 0 0 0.5rem 0; color: #1565c0;">
              üßÆ Shadbala Calculator - Detailed Component Analysis
            </h4>
            <p style="margin: 0; color: #424242; font-size: 0.95rem;">
              Calculate individual strength components using classical Vedic formulas. This section provides detailed breakdowns of each Shadbala component with precise calculations and percentage strengths.
            </p>
          </div>
        </div>
        
        <!-- UchchaBala Detailed Analysis -->
        <div style="margin-bottom: 2rem;">
          <h4 style="color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 0.5rem; margin-bottom: 1rem;">
            üéØ UchchaBala Analysis (Exaltation Strength)
          </h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
      `;
      
      // Add UchchaBala cards for each planet
      Object.entries(shadbala).forEach(([planet, strength]) => {
        console.log('DEBUG: planet:', planet, 'strength:', strength);
        const breakdown = strength.sthana_bala_breakdown || {};
        console.log('DEBUG: breakdown:', breakdown);
        const uchcha_bala = breakdown.uchcha_bala || 0;
        const percentage = (uchcha_bala / 60) * 100; // Max UchchaBala is 60
        
        let strengthLevel = 'Very Weak';
        let colorClass = 'weak';
        if (percentage >= 80) {
          strengthLevel = 'Excellent';
          colorClass = 'excellent';
        } else if (percentage >= 60) {
          strengthLevel = 'Strong'; 
          colorClass = 'strong';
        } else if (percentage >= 40) {
          strengthLevel = 'Good';
          colorClass = 'good';
        } else if (percentage >= 20) {
          strengthLevel = 'Average';
          colorClass = 'average';
        }
        
        calculatorHtml += `
          <div class="uchcha-card uchcha-${colorClass}" style="padding: 1rem; border-radius: 8px; border: 1px solid #ddd; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
              <h5 style="margin: 0; color: #2c3e50;">${planet}</h5>
              <span class="uchcha-badge uchcha-badge-${colorClass}" style="padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                ${strengthLevel}
              </span>
            </div>
            <div style="font-size: 1.5rem; font-weight: bold; color: #495057; margin-bottom: 0.5rem;">
              ${uchcha_bala.toFixed(2)} / 60
            </div>
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.8rem;">
              ${percentage.toFixed(1)}% of maximum strength
            </div>
            <div class="uchcha-bar" style="width: 100%; height: 6px; background: #e9ecef; border-radius: 3px; overflow: hidden;">
              <div style="width: ${Math.min(100, percentage)}%; height: 100%; background: linear-gradient(90deg, #007bff 0%, #28a745 100%); transition: width 0.5s ease;"></div>
            </div>
            <div style="font-size: 0.75rem; color: #6c757d; margin-top: 0.5rem;">
              Formula: Distance from debilitation √∑ 3
            </div>
          </div>
        `;
      });
      
      calculatorHtml += `
          </div>
          
          <div class="uchcha-formula-explanation" style="padding: 1rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #28a745; margin-top: 1rem;">
            <h5 style="margin: 0 0 0.5rem 0; color: #155724;">üìö UchchaBala Formula Explanation:</h5>
            <div style="font-size: 0.9rem; color: #495057; line-height: 1.4;">
              <strong>Classical Formula:</strong> UchchaBala = (Planet Longitude - Debilitation Point) √∑ 3<br>
              <strong>Maximum Value:</strong> 60 points (when planet is at exact exaltation degree)<br>
              <strong>Minimum Value:</strong> 0 points (when planet is at exact debilitation degree)<br>
              <strong>Interpretation:</strong> Measures strength based on distance from weakness point
            </div>
          </div>
        </div>
        
        <!-- SaptavarigiyaBala Analysis -->
        <div style="margin-bottom: 2rem;">
          <h4 style="color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 0.5rem; margin-bottom: 1rem;">
            üéØ SaptavarigiyaBala Analysis (Seven-fold Divisional Strength)
          </h4>
      `;
      
      // Add SaptavarigiyaBala analysis if available
      if (data.shadbala?._saptavargiya_analysis && data.shadbala._saptavargiya_analysis.planet_totals) {
        const saptavargiya = data.shadbala._saptavargiya_analysis;
        const planetTotals = saptavargiya.planet_totals;
        const chartScores = saptavargiya.planet_chart_scores;
        
        calculatorHtml += `
          <div class="saptavargiya-overview" style="margin-bottom: 1.5rem;">
            <div class="highlight" style="padding: 1rem; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: 8px; border-left: 4px solid #ff9800;">
              <h5 style="margin: 0 0 0.5rem 0; color: #e65100;">üìà SaptavarigiyaBala Overview</h5>
              <p style="margin: 0; color: #424242; font-size: 0.9rem;">
                Classical seven-chart analysis combining Rashi, Hora, Drekkana, Saptamsa, Navamsa, Dwadasamsa, and Trimsamsa charts with Panchadha Maitri relationships to determine precise planetary strength.
              </p>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
        `;
        
        // Create cards for each planet's SaptavarigiyaBala
        Object.entries(planetTotals).forEach(([planet, total]) => {
          // Safety check for undefined values
          if (total === undefined || total === null) {
            console.warn(`SaptavarigiyaBala total undefined for ${planet}`);
            total = 0;
          }
          
          const maxPoints = 7 * 45; // Maximum possible points (7 charts √ó 45 Mooltrikona points)
          const percentage = (total / maxPoints) * 100;
          
          let strengthLevel = 'Very Weak';
          let colorClass = 'weak';
          if (percentage >= 70) {
            strengthLevel = 'Excellent';
            colorClass = 'excellent';
          } else if (percentage >= 55) {
            strengthLevel = 'Strong'; 
            colorClass = 'strong';
          } else if (percentage >= 40) {
            strengthLevel = 'Good';
            colorClass = 'good';
          } else if (percentage >= 25) {
            strengthLevel = 'Average';
            colorClass = 'average';
          }
          
          calculatorHtml += `
            <div class="saptavargiya-card saptavargiya-${colorClass}" style="padding: 1rem; border-radius: 8px; border: 1px solid #ddd; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
                <h5 style="margin: 0; color: #2c3e50;">${planet}</h5>
                <span class="saptavargiya-badge saptavargiya-badge-${colorClass}" style="padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                  ${strengthLevel}
                </span>
              </div>
              <div style="font-size: 1.5rem; font-weight: bold; color: #495057; margin-bottom: 0.5rem;">
                ${total.toFixed(1)} / ${maxPoints}
              </div>
              <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.8rem;">
                ${percentage.toFixed(1)}% of maximum strength
              </div>
              <div class="saptavargiya-bar" style="width: 100%; height: 6px; background: #e9ecef; border-radius: 3px; overflow: hidden;">
                <div style="width: ${Math.min(100, percentage)}%; height: 100%; background: linear-gradient(90deg, #ff9800 0%, #4caf50 100%); transition: width 0.5s ease;"></div>
              </div>
              <button onclick="showSaptavargivaDetails('${planet}')" style="margin-top: 0.8rem; padding: 0.4rem 0.8rem; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">
                View Chart Breakdown
              </button>
            </div>
          `;
        });
        
        calculatorHtml += `
          </div>
          
          <div class="saptavargiya-formula-explanation" style="padding: 1rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #ff9800; margin-top: 1rem;">
            <h5 style="margin: 0 0 0.5rem 0; color: #e65100;">üìö SaptavarigiyaBala Point System:</h5>
            <div style="font-size: 0.9rem; color: #495057; line-height: 1.4;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                <div><strong>Mooltrikona:</strong> 45 points</div>
                <div><strong>Own Sign:</strong> 30 points</div>
                <div><strong>Extreme Friend:</strong> 22.5 points</div>
                <div><strong>Friend:</strong> 15 points</div>
                <div><strong>Neutral:</strong> 7.5 points</div>
                <div><strong>Enemy:</strong> 3.75 points</div>
                <div><strong>Extreme Enemy:</strong> 1.875 points</div>
              </div>
            </div>
          </div>
          
          <!-- Detailed Chart Breakdown Modal (will be populated dynamically) -->
          <div id="saptavargiya-details-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; max-width: 80%; max-height: 80%; overflow-y: auto;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h4 id="saptavargiya-modal-title">Planet Chart Breakdown</h4>
                <button onclick="closeSaptavargivaDetails()" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 0.5rem; cursor: pointer;">√ó</button>
              </div>
              <div id="saptavargiya-modal-content"></div>
            </div>
          </div>
        `;
      } else {
        calculatorHtml += `
          <div style="padding: 1rem; background: #f8f9fa; border-radius: 6px; color: #666; text-align: center;">
            SaptavarigiyaBala analysis not available. This requires comprehensive divisional chart and Panchadha Maitri calculations.
          </div>
        `;
      }
      
      calculatorHtml += `
        </div>
      `;
      
      content.innerHTML = calculatorHtml;
    }

    function renderDivisionalChartsSection(data) {
      const content = document.getElementById('divisional-charts-details');
      const divisionalCharts = data.divisional_charts || {};
      
      if (!divisionalCharts || Object.keys(divisionalCharts).length === 0) {
        content.innerHTML = '<p>No divisional charts data available.</p>';
        return;
      }
      
      let chartsHtml = `
        <div style="margin-bottom: 2rem;">
          <div class="highlight" style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); border-radius: 8px; border-left: 4px solid #28a745;">
            <h4 style="margin: 0 0 0.5rem 0; color: #155724;">
              üìä Divisional Charts (Vargas) - BPHS Traditional Calculations
            </h4>
            <p style="margin: 0; color: #424242; font-size: 0.95rem;">
              Examine planetary placements in various divisional charts using classical Vedic formulas. Each chart reveals specific aspects of life and planetary strength.
            </p>
          </div>
        </div>
      `;
      
      // Chart descriptions
      const chartDescriptions = {
        'D2': 'Wealth, family values, and material resources',
        'D3': 'Siblings, communication, short journeys, and courage',
        'D7': 'Children, creativity, and progeny matters',
        'D9': 'Marriage, dharma, fortune, and spiritual path',
        'D12': 'Parents, ancestors, and family lineage',
        'D30': 'Struggles, obstacles, and challenges in life'
      };
      
      // Create tabs for each chart
      const chartKeys = ['D2', 'D3', 'D7', 'D9', 'D12', 'D30'];
      
      // Generate tab navigation
      chartsHtml += `
        <div class="divisional-charts-container">
          <div class="chart-tabs" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid #e9ecef; padding-bottom: 0.5rem;">
      `;
      
      chartKeys.forEach((chartKey, index) => {
        const chart = divisionalCharts[chartKey] || {};
        const isActive = index === 0 ? 'active' : '';
        chartsHtml += `
          <button class="chart-tab-btn ${isActive}" onclick="showDivisionalChart('${chartKey}')" 
                  style="padding: 0.5rem 1rem; border: none; background: ${index === 0 ? '#007bff' : '#f8f9fa'}; 
                         color: ${index === 0 ? 'white' : '#495057'}; border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.3s;">
            ${chart.name || chartKey}
          </button>
        `;
      });
      
      chartsHtml += `
          </div>
          
          <div class="chart-contents">
      `;
      
      // Generate content for each chart
      chartKeys.forEach((chartKey, index) => {
        const chart = divisionalCharts[chartKey] || {};
        const isActive = index === 0 ? 'block' : 'none';
        const description = chartDescriptions[chartKey] || 'Specialized divisional analysis';
        
        chartsHtml += `
          <div id="chart-${chartKey}" class="chart-content" style="display: ${isActive};">
            <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #17a2b8;">
              <h5 style="margin: 0 0 0.5rem 0; color: #0c5460;">
                ${chart.name || chartKey} - ${description}
              </h5>
              <div style="font-size: 0.9rem; color: #6c757d;">
                Division: ${chart.division || 'N/A'} parts per sign ‚Ä¢ Traditional ${chartKey} analysis
              </div>
            </div>
        `;
        
        if (chart.error) {
          chartsHtml += `
            <div style="padding: 1rem; background: #f8d7da; color: #721c24; border-radius: 6px; border-left: 4px solid #dc3545;">
              <strong>Calculation Error:</strong> ${chart.error}
            </div>
          `;
        } else if (chart.planetsByHouse) {
          // Render the 8x8 South Indian style chart
          chartsHtml += `
            <div class="divisional-chart-grid" style="margin-bottom: 2rem;">
              <table class="south-indian-chart" style="width: 100%; border-collapse: collapse; margin: 0 auto; max-width: 600px;">
          `;
          
          // Generate South Indian style chart (same format as main chart)
          for (let row = 0; row < 4; row++) {
            chartsHtml += '<tr>';
            for (let col = 0; col < 4; col++) {
              // Skip cells that are covered by the center label's colspan/rowspan
              if ((row === 1 && col === 2) || (row === 2 && col === 1) || (row === 2 && col === 2)) {
                continue;
              }
              
              let houseNum;
              
              // South Indian chart house mapping
              if (row === 0 && col === 0) houseNum = 12;
              else if (row === 0 && col === 1) houseNum = 1;
              else if (row === 0 && col === 2) houseNum = 2;
              else if (row === 0 && col === 3) houseNum = 3;
              else if (row === 1 && col === 0) houseNum = 11;
              else if (row === 1 && col === 1) houseNum = null; // Center area with chart label
              else if (row === 1 && col === 3) houseNum = 4;
              else if (row === 2 && col === 0) houseNum = 10;
              else if (row === 2 && col === 3) houseNum = 5;
              else if (row === 3 && col === 0) houseNum = 9;
              else if (row === 3 && col === 1) houseNum = 8;
              else if (row === 3 && col === 2) houseNum = 7;
              else if (row === 3 && col === 3) houseNum = 6;
              
              if (houseNum === null) {
                // Center cell with chart name spanning 2x2 area
                const chartLabel = chartKey === 'D2' ? 'HORA' : 
                                 chartKey === 'D3' ? 'DREKKANA' :
                                 chartKey === 'D7' ? 'SAPTAMSA' :
                                 chartKey === 'D9' ? 'NAVAMSA' :
                                 chartKey === 'D12' ? 'DWADASAMSA' :
                                 chartKey === 'D30' ? 'TRIMSAMSA' : chartKey;
                
                chartsHtml += `<td colspan="2" rowspan="2" class="chart-label-cell" style="border: 2px solid #007bff; width: 50%; height: 160px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 50%, #90caf9 100%); display: table-cell; vertical-align: middle; text-align: center; position: relative;">
                  <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; padding: 10px;">
                    <div style="font-weight: bold; font-size: 1.4rem; color: #0d47a1; line-height: 1.2; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">${chartLabel}</div>
                    <div style="font-size: 0.9rem; color: #1565c0; margin-top: 4px; font-weight: 600;">(${chartKey})</div>
                    <div style="font-size: 0.75rem; color: #424242; margin-top: 4px; opacity: 0.8;">Division: ${chart.division || 'N/A'}</div>
                  </div>
                </td>`;
              } else {
                const planetsInHouse = chart.planetsByHouse[houseNum.toString()] || [];
                chartsHtml += `
                  <td class="sign-cell" data-house="${houseNum}" style="border: 2px solid #495057; width: 25%; height: 80px; position: relative; background: white; vertical-align: top; padding: 4px;">
                    <div class="sign-content" style="height: 100%; display: flex; flex-direction: column;">
                      <div class="sign-number" style="font-weight: bold; font-size: 0.8rem; color: #6c757d; margin-bottom: 2px;">${houseNum}</div>
                      <div class="planets-container" style="flex: 1; display: flex; flex-wrap: wrap; gap: 2px; align-content: flex-start;">
                `;
                
                planetsInHouse.forEach(planet => {
                  const isAscendant = planet.name === 'Lagna';
                  const displayName = isAscendant ? 'ASC' : planet.abbr;
                  const bgColor = isAscendant ? '#ffc107' : 
                                 ['Sun', 'Mars'].includes(planet.name) ? '#dc3545' :
                                 ['Jupiter', 'Venus'].includes(planet.name) ? '#28a745' :
                                 '#6c757d';
                  
                  chartsHtml += `
                    <span class="planet-marker ${isAscendant ? 'ascendant-marker' : ''}" style="background: ${bgColor}; color: ${isAscendant ? '#212529' : 'white'}; padding: 1px 3px; border-radius: 3px; font-size: ${isAscendant ? '0.75rem' : '0.7rem'}; font-weight: bold; line-height: 1; min-width: 16px; text-align: center; ${isAscendant ? 'border: 1px solid #ffc107;' : ''}" title="${planet.name} in ${planet.sign} (Ruler: ${planet.ruler})">
                      ${displayName}
                    </span>
                  `;
                });
                
                chartsHtml += `
                      </div>
                    </div>
                  </td>
                `;
              }
            }
            chartsHtml += '</tr>';
          }
          
          chartsHtml += `
              </table>
            </div>
          `;
          
          // Add detailed positions table
          chartsHtml += `
            <div class="positions-table-container" style="margin-top: 1.5rem;">
              <h6 style="margin-bottom: 1rem; color: #495057;">Detailed Positions in ${chart.name}:</h6>
              <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                  <thead style="background: #e9ecef;">
                    <tr>
                      <th style="border: 1px solid #dee2e6; padding: 0.5rem; text-align: left;">Planet/Point</th>
                      <th style="border: 1px solid #dee2e6; padding: 0.5rem; text-align: left;">Sign</th>
                      <th style="border: 1px solid #dee2e6; padding: 0.5rem; text-align: left;">Ruler</th>
                      <th style="border: 1px solid #dee2e6; padding: 0.5rem; text-align: left;">Division</th>
                    </tr>
                  </thead>
                  <tbody>
          `;
          
          if (chart.positions) {
            Object.entries(chart.positions).forEach(([body, position]) => {
              const isLagna = body === 'Lagna';
              const displayName = isLagna ? 'Ascendant' : body;
              const rowColor = isLagna ? '#fff3cd' : 'white';
              chartsHtml += `
                <tr style="background: ${rowColor};">
                  <td style="border: 1px solid #dee2e6; padding: 0.5rem; font-weight: ${isLagna ? 'bold' : 'normal'};">${displayName}</td>
                  <td style="border: 1px solid #dee2e6; padding: 0.5rem;">${position.sign || 'N/A'}</td>
                  <td style="border: 1px solid #dee2e6; padding: 0.5rem;">${position.ruler || 'N/A'}</td>
                  <td style="border: 1px solid #dee2e6; padding: 0.5rem;">${position.division_index || 'N/A'}</td>
                </tr>
              `;
            });
          }
          
          chartsHtml += `
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }
        
        chartsHtml += '</div>';
      });
      
      chartsHtml += `
          </div>
        </div>
      `;
      
      content.innerHTML = chartsHtml;
    }

    function showDivisionalChart(chartKey) {
      // Hide all chart contents
      document.querySelectorAll('.chart-content').forEach(content => {
        content.style.display = 'none';
      });
      
      // Remove active class from all tab buttons
      document.querySelectorAll('.chart-tab-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '#f8f9fa';
        btn.style.color = '#495057';
      });
      
      // Show selected chart content
      const selectedContent = document.getElementById(`chart-${chartKey}`);
      if (selectedContent) {
        selectedContent.style.display = 'block';
      }
      
      // Add active class to clicked tab button
      event.target.classList.add('active');
      event.target.style.background = '#007bff';
      event.target.style.color = 'white';
    }

    function renderPanchadhaMaitriSection(data) {
      const content = document.getElementById('panchadha-maitri-details');
      const maitri = data.panchadha_maitri || {};
      
      if (!maitri || Object.keys(maitri).length === 0) {
        content.innerHTML = '<p>No Panchadha Maitri data available.</p>';
        return;
      }
      
      const planets = ['Sun', 'Moon', 'Mars', 'Mercury', 'Jupiter', 'Venus', 'Saturn'];
      
      let maitriHtml = `
        <div style="margin-bottom: 2rem;">
          <div class="highlight" style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%); border-radius: 8px; border-left: 4px solid #28a745;">
            <h4 style="margin: 0 0 0.5rem 0; color: #155724;">
              ü§ù Panchadha Maitri Analysis - Five-fold Friendship System
            </h4>
            <p style="margin: 0; color: #424242; font-size: 0.95rem;">
              Classical Vedic system combining permanent (Naisargik) and temporary (Tatkalik) relationships to determine final planetary friendships.
            </p>
          </div>
        </div>

        <div class="maitri-tabs" style="display: flex; margin-bottom: 1.5rem; border-bottom: 2px solid #e9ecef;">
          <button class="maitri-tab-btn active" onclick="showMaitriTable('naisargika')" style="padding: 0.75rem 1.5rem; border: none; background: #28a745; color: white; border-radius: 6px 6px 0 0; margin-right: 2px; cursor: pointer; font-weight: 600;">
            Naisargika (Natural)
          </button>
          <button class="maitri-tab-btn" onclick="showMaitriTable('tatkaala')" style="padding: 0.75rem 1.5rem; border: none; background: #f8f9fa; color: #495057; border-radius: 6px 6px 0 0; margin-right: 2px; cursor: pointer; font-weight: 600;">
            Tatkaala (Temporary)
          </button>
          <button class="maitri-tab-btn" onclick="showMaitriTable('panchadha')" style="padding: 0.75rem 1.5rem; border: none; background: #f8f9fa; color: #495057; border-radius: 6px 6px 0 0; cursor: pointer; font-weight: 600;">
            Panchadha (Final)
          </button>
        </div>
      `;

      // Naisargika Maitri Table
      if (maitri.naisargika_maitri) {
        maitriHtml += `
          <div class="maitri-content" id="maitri-naisargika" style="display: block;">
            <h4 style="color: #28a745; margin-bottom: 1rem;">üìö Naisargika Maitri (Natural/Permanent Friendship)</h4>
            ${generateMaitriTable(maitri.naisargika_maitri, planets, 'naisargika')}
          </div>
        `;
      }

      // Tatkaala Maitri Table
      if (maitri.tatkaala_maitri) {
        maitriHtml += `
          <div class="maitri-content" id="maitri-tatkaala" style="display: none;">
            <h4 style="color: #007bff; margin-bottom: 1rem;">üè† Tatkaala Maitri (Temporary Friendship - Based on House Positions)</h4>
            ${generateMaitriTable(maitri.tatkaala_maitri, planets, 'tatkaala')}
            <div style="margin-top: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #007bff;">
              <small style="color: #495057;">
                <strong>House Rule:</strong> Friends in houses 2,3,4,10,11,12 | Enemies in houses 1,5,6,7,8,9
              </small>
            </div>
          </div>
        `;
      }

      // Panchadha Maitri Table
      if (maitri.panchadha_maitri) {
        maitriHtml += `
          <div class="maitri-content" id="maitri-panchadha" style="display: none;">
            <h4 style="color: #dc3545; margin-bottom: 1rem;">üéØ Panchadha Maitri (Final Combined Relationship)</h4>
            ${generatePanchadhaMaitriTable(maitri.panchadha_maitri, planets)}
            <div style="margin-top: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #dc3545;">
              <div style="font-size: 0.85rem; color: #495057;">
                <strong>Legend:</strong> 
                <span style="color: #28a745; font-weight: 600;">EF</span> = Extreme Friend | 
                <span style="color: #17a2b8; font-weight: 600;">F</span> = Friend | 
                <span style="color: #6c757d; font-weight: 600;">N</span> = Neutral | 
                <span style="color: #fd7e14; font-weight: 600;">E</span> = Enemy | 
                <span style="color: #dc3545; font-weight: 600;">EE</span> = Extreme Enemy
              </div>
            </div>
          </div>
        `;
      }

      content.innerHTML = maitriHtml;

      // Helper function to generate basic maitri table
      function generateMaitriTable(tableData, planets, type) {
        let tableHtml = `
          <div class="table-responsive">
            <table class="table table-bordered" style="margin-bottom: 0;">
              <thead style="background: #f8f9fa;">
                <tr>
                  <th style="text-align: center; padding: 0.75rem; font-weight: 600;">From \\\\ To</th>
        `;
        
        planets.forEach(planet => {
          tableHtml += `<th style="text-align: center; padding: 0.5rem; font-weight: 600; font-size: 0.9rem;">${planet}</th>`;
        });
        
        tableHtml += '</tr></thead><tbody>';
        
        planets.forEach(planetFrom => {
          if (!tableData[planetFrom]) return;
          
          tableHtml += `<tr><td style="font-weight: 600; padding: 0.75rem; background: #f8f9fa;">${planetFrom}</td>`;
          
          planets.forEach(planetTo => {
            const relationship = tableData[planetFrom][planetTo] || 'N/A';
            const colorClass = getRelationshipColor(relationship, type);
            
            tableHtml += `
              <td style="text-align: center; padding: 0.5rem; ${colorClass}">
                <span style="font-weight: 600; font-size: 0.85rem;">${relationship}</span>
              </td>
            `;
          });
          
          tableHtml += '</tr>';
        });
        
        tableHtml += '</tbody></table></div>';
        return tableHtml;
      }

      // Helper function to generate panchadha maitri table with codes
      function generatePanchadhaMaitriTable(tableData, planets) {
        let tableHtml = `
          <div class="table-responsive">
            <table class="table table-bordered" style="margin-bottom: 0;">
              <thead style="background: #f8f9fa;">
                <tr>
                  <th style="text-align: center; padding: 0.75rem; font-weight: 600;">From \\\\ To</th>
        `;
        
        planets.forEach(planet => {
          tableHtml += `<th style="text-align: center; padding: 0.5rem; font-weight: 600; font-size: 0.9rem;">${planet}</th>`;
        });
        
        tableHtml += '</tr></thead><tbody>';
        
        planets.forEach(planetFrom => {
          if (!tableData[planetFrom]) return;
          
          tableHtml += `<tr><td style="font-weight: 600; padding: 0.75rem; background: #f8f9fa;">${planetFrom}</td>`;
          
          planets.forEach(planetTo => {
            const relationData = tableData[planetFrom][planetTo] || {};
            const code = relationData.code || 'N';
            const resultant = relationData.resultant || 'Neutral';
            const colorClass = getPanchadhaColor(code);
            
            tableHtml += `
              <td style="text-align: center; padding: 0.5rem; ${colorClass}" title="${resultant}">
                <span style="font-weight: 600; font-size: 0.9rem;">${code}</span>
              </td>
            `;
          });
          
          tableHtml += '</tr>';
        });
        
        tableHtml += '</tbody></table></div>';
        return tableHtml;
      }

      // Helper function to get relationship colors
      function getRelationshipColor(relationship, type) {
        if (relationship === 'Self') return 'background: #6c757d; color: white;';
        if (relationship === 'Friend') return 'background: #d4edda; color: #155724;';
        if (relationship === 'Neutral') return 'background: #fff3cd; color: #856404;';
        if (relationship === 'Enemy') return 'background: #f8d7da; color: #721c24;';
        return 'background: #e2e3e5; color: #383d41;';
      }

      // Helper function to get panchadha colors
      function getPanchadhaColor(code) {
        switch(code) {
          case 'EF': return 'background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;';
          case 'F': return 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;';
          case 'N': return 'background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;';
          case 'E': return 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;';
          case 'EE': return 'background: #f5c6cb; color: #721c24; border: 1px solid #f1b0b7;';
          case 'S': return 'background: #6c757d; color: white; border: 1px solid #5a6268;';
          default: return 'background: #e2e3e5; color: #383d41;';
        }
      }
    }

    function showMaitriTable(tableType) {
      // Hide all maitri contents
      document.querySelectorAll('.maitri-content').forEach(content => {
        content.style.display = 'none';
      });
      
      // Remove active class from all maitri tab buttons
      document.querySelectorAll('.maitri-tab-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = '#f8f9fa';
        btn.style.color = '#495057';
      });
      
      // Show selected maitri content
      const selectedContent = document.getElementById(`maitri-${tableType}`);
      if (selectedContent) {
        selectedContent.style.display = 'block';
      }
      
      // Add active class to clicked tab button
      event.target.classList.add('active');
      event.target.style.background = tableType === 'naisargika' ? '#28a745' : (tableType === 'tatkaala' ? '#007bff' : '#dc3545');
      event.target.style.color = 'white';
    }

    function renderMahadashSection(data) {
      const content = document.getElementById('mahadasha-details');
      const vim = data.vimshottari || {};
      
      if (!vim.mahadashas) {
        content.innerHTML = '<p>No Vimshottari dasha data available.</p>';
        return;
      }
      
      const lord = vim.nakshatraLord;
      const balY = vim.balanceAtBirthYears || 0;
      const y = Math.floor(balY);
      const remDays = (balY - y) * 365.2425;
      const m = Math.floor(remDays / 30.436875);
      const d = Math.round(remDays - m*30.436875);
      
      const fmtDMY = (iso) => {
        const dt = new Date(iso);
        if (isNaN(dt.getTime())) return iso;
        const dd = String(dt.getDate()).padStart(2,'0');
        const mm = String(dt.getMonth()+1).padStart(2,'0');
        const yyyy = dt.getFullYear();
        return `${dd}/${mm}/${yyyy}`;
      };
      
      let dashHtml = `
        <div class="highlight" style="margin-bottom: 1rem;">
          <strong>Nakshatra Lord at birth:</strong> ${lord || ''} ‚Ä¢ 
          <strong>Balance at birth:</strong> ${y}y ${m}m ${d}d
        </div>
        <table class="data-table">
          <thead>
            <tr><th>Dasha Level</th><th>Lord</th><th>Start</th><th>End</th><th>Duration</th></tr>
          </thead>
          <tbody>
      `;
      
      vim.mahadashas.forEach((md, idx) => {
        dashHtml += `
          <tr style="background: #f8f9fa; font-weight: bold;">
            <td>Mahadasha</td>
            <td>${md.lord}</td>
            <td>${fmtDMY(md.start)}</td>
            <td>${fmtDMY(md.end)}</td>
            <td>${md.years}y</td>
          </tr>
        `;
        
        if (idx < 3) { // Show first 3 MDs with details
          md.antardashas?.forEach(ad => {
            dashHtml += `
              <tr style="background: #fafafa;">
                <td style="padding-left: 1rem;">‚Üí Antardasha</td>
                <td>${ad.lord}</td>
                <td>${fmtDMY(ad.start)}</td>
                <td>${fmtDMY(ad.end)}</td>
                <td></td>
              </tr>
            `;
          });
        }
      });
      
      dashHtml += '</tbody></table>';
      content.innerHTML = dashHtml;
    }

    function renderYearlySection(data) {
      const content = document.getElementById('yearly-details');
      const yearly = data.yearly_dasha || {};
      
      if (!Object.keys(yearly).length) {
        content.innerHTML = '<p>No yearly dasha data available.</p>';
        return;
      }
      
      let yearlyHtml = '';
      
      Object.entries(yearly).forEach(([year, yearData]) => {
        const quarters = yearData.quarterly_summary || {};
        
        yearlyHtml += `
          <div class="data-card" style="margin-bottom: 1rem;">
            <h4>üìÖ ${year}</h4>
            <div style="margin: 0.5rem 0;">
              <strong>Total Periods:</strong> ${yearData.total_periods || 0}
            </div>
            <div class="data-grid" style="grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
              <div><strong>Q1 (Jan-Mar):</strong><br>${quarters.Q1 || 'No periods'}</div>
              <div><strong>Q2 (Apr-Jun):</strong><br>${quarters.Q2 || 'No periods'}</div>
              <div><strong>Q3 (Jul-Sep):</strong><br>${quarters.Q3 || 'No periods'}</div>
              <div><strong>Q4 (Oct-Dec):</strong><br>${quarters.Q4 || 'No periods'}</div>
            </div>
          </div>
        `;
      });
      
      content.innerHTML = yearlyHtml;
    }

    function updateSectionSummaries(data) {
      // Update section summaries
      const planetCount = Object.keys(data.planetary_analysis || {}).length;
      document.getElementById('planets-summary').textContent = `${planetCount} planets analyzed with detailed positions`;
      
      // Shadbala summary
      const shadbala = data.shadbala?.shadbala_scores || {};
      const strongPlanets = Object.values(shadbala).filter(p => p.strength_percentage >= 100).length;
      const totalPlanets = Object.keys(shadbala).length;
      document.getElementById('shadbala-summary').textContent = `${strongPlanets}/${totalPlanets} planets have strong Shadbala scores`;
      
      const occupiedHouses = Object.values(data.house_analysis || {}).filter(h => h.is_occupied).length;
      document.getElementById('houses-summary').textContent = `${occupiedHouses} houses occupied, 12 total analyzed`;
      
      const nakshatraCount = Object.keys(data.nakshatra_details || {}).length;
      document.getElementById('nakshatras-summary').textContent = `${nakshatraCount} planetary nakshatras calculated`;
      
      const transitTime = data.current_transits?.calculation_time;
      if (transitTime) {
        document.getElementById('transits-summary').textContent = `Current positions as of ${new Date(transitTime).toLocaleDateString()}`;
      }
      
      const totalMDs = data.vimshottari?.mahadashas?.length || 0;
      document.getElementById('mahadasha-summary').textContent = `${totalMDs} mahadashas in 120-year cycle`;
      
      const yearsCovered = Object.keys(data.yearly_dasha || {}).length;
      document.getElementById('yearly-summary').textContent = `${yearsCovered} years of dasha periods calculated`;
    }

    // SaptavarigiyaBala modal functions
    function showSaptavargivaDetails(planet) {
      const modal = document.getElementById('saptavargiya-details-modal');
      const title = document.getElementById('saptavargiya-modal-title');
      const content = document.getElementById('saptavargiya-modal-content');
      
      if (!window.lastChartData || !window.lastChartData.shadbala?._saptavargiya_analysis) {
        alert('SaptavarigiyaBala data not available');
        return;
      }
      
      const saptavargiya = window.lastChartData.shadbala._saptavargiya_analysis;
      const planetScores = saptavargiya.planet_chart_scores ? saptavargiya.planet_chart_scores[planet] : null;
      let total = saptavargiya.planet_totals ? saptavargiya.planet_totals[planet] : 0;
      
      if (!planetScores) {
        alert(`No SaptavarigiyaBala data available for ${planet}`);
        return;
      }
      
      // Safety check for total
      if (total === undefined || total === null) {
        console.warn(`SaptavarigiyaBala total undefined for ${planet} in modal`);
        total = 0;
      }
      
      title.textContent = `${planet} - SaptavarigiyaBala Chart Breakdown`;
      
      let detailsHtml = `
        <div style="margin-bottom: 1rem;">
          <h5 style="color: #2c3e50; margin: 0 0 0.5rem 0;">Total Points: ${total.toFixed(1)} / 315</h5>
          <p style="color: #666; margin: 0; font-size: 0.9rem;">Breakdown across seven divisional charts</p>
        </div>
        
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 1rem;">
            <thead>
              <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                <th style="padding: 0.75rem; text-align: left; border: 1px solid #dee2e6;">Chart</th>
                <th style="padding: 0.75rem; text-align: left; border: 1px solid #dee2e6;">Sign</th>
                <th style="padding: 0.75rem; text-align: left; border: 1px solid #dee2e6;">Ruler</th>
                <th style="padding: 0.75rem; text-align: left; border: 1px solid #dee2e6;">Relationship</th>
                <th style="padding: 0.75rem; text-align: right; border: 1px solid #dee2e6;">Points</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      Object.entries(planetScores).forEach(([chartNum, data]) => {
        const relationshipColor = {
          'Mooltrikona': '#4caf50',
          'Own': '#2196f3',
          'Extreme Friend': '#ff9800',
          'Friend': '#ffc107',
          'Neutral': '#6c757d',
          'Enemy': '#ff5722',
          'Extreme Enemy': '#f44336'
        }[data.relationship] || '#6c757d';
        
        detailsHtml += `
          <tr style="border-bottom: 1px solid #dee2e6;">
            <td style="padding: 0.75rem; border: 1px solid #dee2e6; font-weight: 500;">${data.chart_name}</td>
            <td style="padding: 0.75rem; border: 1px solid #dee2e6;">${data.sign_name}</td>
            <td style="padding: 0.75rem; border: 1px solid #dee2e6;">${data.ruler}</td>
            <td style="padding: 0.75rem; border: 1px solid #dee2e6;">
              <span style="color: ${relationshipColor}; font-weight: 500;">${data.relationship}</span>
            </td>
            <td style="padding: 0.75rem; border: 1px solid #dee2e6; text-align: right; font-weight: 600;">
              ${data.points}
            </td>
          </tr>
        `;
      });
      
      detailsHtml += `
            </tbody>
          </table>
        </div>
        
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; border-left: 4px solid #007bff;">
          <h6 style="margin: 0 0 0.5rem 0; color: #495057;">Calculation Method:</h6>
          <p style="margin: 0; font-size: 0.85rem; color: #666; line-height: 1.4;">
            Each divisional chart position is analyzed for the planet's relationship with the sign ruler using Panchadha Maitri (Five-fold Friendship). 
            Points are awarded based on the relationship strength, with Mooltrikona being the highest (45 points) and Extreme Enemy the lowest (1.875 points).
          </p>
        </div>
      `;
      
      content.innerHTML = detailsHtml;
      modal.style.display = 'block';
    }
    
    function closeSaptavargivaDetails() {
      document.getElementById('saptavargiya-details-modal').style.display = 'none';
    }
    
    // Close modal when clicking outside
    document.addEventListener('click', function(event) {
      const modal = document.getElementById('saptavargiya-details-modal');
      if (event.target === modal) {
        closeSaptavargivaDetails();
      }
    });
  </script>
</body>
</html>